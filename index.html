<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="Kn55h2vCsmSGHs9XInHq814M5vYSysviS3wsF5u88o0" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Microsoft YaHei:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo114.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo32.svg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo32.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, Charles" />





  <link rel="alternate" href="/atom.xml" title="SIGABRT" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="SIGABRT">
<meta property="og:url" content="http://gobodigo.com/index.html">
<meta property="og:site_name" content="SIGABRT">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SIGABRT">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://gobodigo.com/"/>





  <title>SIGABRT - Seeking Thinking Realizing Value</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4f0f6a13270382ca7ac23fd9d6ca150c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SIGABRT</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Seeking Thinking Realizing Value</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2018/07/28/ios-runloop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/28/ios-runloop/" itemprop="url">iOS Runloop 深入浅出</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-28T14:38:09+08:00">
                2018-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/28/ios-runloop/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/28/ios-runloop/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/28/ios-runloop/" class="leancloud_visitors" data-flag-title="iOS Runloop 深入浅出">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="iOS-Runloop-深入浅出"><a href="#iOS-Runloop-深入浅出" class="headerlink" title="iOS Runloop 深入浅出"></a>iOS Runloop 深入浅出</h1><h2 id="Runloop是什么？"><a href="#Runloop是什么？" class="headerlink" title="Runloop是什么？"></a>Runloop是什么？</h2><p>苹果官方文档解释：</p>
<blockquote>
<p>A run loop is a piece of infrastructure used to manage events arriving asynchronously on a thread. A run loop works by monitoring one or more event sources for the thread. As events arrive, the system wakes up the thread and dispatches the events to the run loop, which then dispatches them to the handlers you specify. If no events are present and ready to be handled, the run loop puts the thread to sleep.</p>
</blockquote>
<p>根据以上这个段落，我们能够得知一个重要的信息，<strong>Runloop</strong>是用来处理异步达到<strong>线程</strong>上事件的一种基础结构。所以，要想理解好<strong>Runloop</strong>，我们首先得把<strong>线程</strong>理解清楚了，许多同学跳过线程直接去理解<strong>Runloop</strong>(更不可取的是有部分同学只是为了应付面试而死背硬记Runloop相关知识，往往过后就忘记了)，往往搞得一头雾水，不理解为什么要有这种东西，即使网络上看了几篇直接讲述<strong>Runloop</strong>并贴有很多源代码分析的文章，也始终没有搞懂来龙去脉。要记住，<strong>Runloop</strong>仅仅只是管理事件异步达到线程的一种结构而已，其目的是解决多线程管理中的问题（线程管理中，还有其他手段可以实现类似Runloop这种机制，例如使用信号量, 只不过依赖Runloop更为简单）。</p>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><p>偷个懒，还是借用苹果官方文档的解释来解释什么是线程:]</p>
<blockquote>
<p>Each process (application) in OS X or iOS is made up of one or more threads, each of which represents a single path of execution through the application’s code. Every application starts with a single thread, which runs the application’s main function. Applications can spawn additional threads, each of which executes the code of a specific function.</p>
<p>When an application spawns a new thread, that thread becomes an independent entity inside of the application’s process space. Each thread has its own execution stack and is scheduled for runtime separately by the kernel. A thread can communicate with other threads and other processes, perform I/O operations, and do anything else you might need it to do. Because they are inside the same process space, however, all threads in a single application share the same virtual memory space and have the same access rights as the process itself.</p>
</blockquote>
<p>大意就是每个OS X或者iOS每个应用程序都会以一个线程开始，这个线程执行应用程序的main方法。应用程序可以产生多个线程，每个线程在应用程序内都会有独立的处理空间、堆栈并且被kernel分别在运行时安排执行时间。一个线程可以与同进程内的其他线程通信甚至其他进程、执行I/O操作或者是任何你想让它做的事情。</p>
<h3 id="为什么需要有线程？"><a href="#为什么需要有线程？" class="headerlink" title="为什么需要有线程？"></a>为什么需要有线程？</h3><p>在传统的操作系统中，进程拥有独立的内存地址空间和一个用于控制的线程。但是，现在的情况更多的情况下要求在同一地址空间下拥有多个线程并发执行。因此线程被引入操作系统。</p>
<p> 如果非要说是为什么需要线程，还不如说为什么需要进程中还有其它进程。这些进程中包含的其它迷你进程就是线程线程之所以说是迷你进程，是因为线程和进程有很多相似之处，比如线程和进程的状态都有运行，就绪，阻塞状态。这几种状态理解起来非常简单，当进程所需的资源没有到位时会是阻塞状态，当进程所需的资源到位时但CPU没有到位时是就绪状态，当进程既有所需的资源，又有CPU时，就为运行状态。</p>
<p>假设没有线程，相当于进程只有一个线程，很多情况下的用户体验是无法接受的。来看一个具体的例子，使用iPhone拍摄视频或者照片后，相机app需要将照片或者视频写入磁盘，而访问磁盘的时间内线程是阻塞的，这个时候在相机app无论执行什么操作都不会相应，因为仅有的线程在忙着处理数据写入呢。而如果引入了多线程，每个线程仅仅需要处理自己那一部分应该完成的任务，而不用去关心和其他线程的冲突，因此简化了编程模型。</p>
<h3 id="创建一个线程"><a href="#创建一个线程" class="headerlink" title="创建一个线程"></a>创建一个线程</h3><p>使用<strong>NSThread</strong>创建线程</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(onThreadStart:) object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.thread.name = <span class="string">@"myThread"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)onThreadStart:(<span class="keyword">id</span>)args &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Execution in thread [%@]"</span>, [<span class="built_in">NSThread</span> currentThread].name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)persistVideoClips &#123;</span><br><span class="line">    <span class="comment">//这里有存储视频信息的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到控制台打印<code>Execution in thread [myThread]</code></p>
<h3 id="使用线程"><a href="#使用线程" class="headerlink" title="使用线程"></a>使用线程</h3><p>继续前面讲的存储视频的例子，我们在界面加上一个按钮，每次点击就使用线程模拟保存视频(也许你会说，可以使用GCD或者NSOperationQueue来完成啊！对，但是这两个也都是苹果提供的多线程管理库，我们要研究为什么苹果引入Runloop就需要从线程上去考虑)。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.videoClips = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)onButtonTapped:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">   <span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(onThreadStart:) object:[<span class="keyword">self</span>.videoClips <span class="keyword">copy</span>]];</span><br><span class="line">    <span class="keyword">self</span>.thread.name = <span class="string">@"myThread"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)onThreadStart:(<span class="keyword">id</span>)args &#123;</span><br><span class="line">    <span class="comment">//这里有存储视频信息的代码</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@"Execution in thread [%@]"</span>, [<span class="built_in">NSThread</span> currentThread].name);</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@"saving video clips"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方式是强烈不推荐的，想必也没有人会这么干，因为线程的创建是昂贵的。</p>
<blockquote>
<p>Threading has a real cost to your program (and the system) in terms of memory use and performance. Each thread requires the allocation of memory in both the kernel memory space and your program’s memory space. The core structures needed to manage your thread and coordinate its scheduling are stored in the kernel using wired memory. Your thread’s stack space and per-thread data is stored in your program’s memory space. Most of these structures are created and initialized when you first create the thread—a process that can be relatively expensive because of the required interactions with the kernel.</p>
</blockquote>
<p>为了解决消耗这个问题，聪明的人对线程进行了封装，使用继承实现了自己的<code>LCThread</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LCThread.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^LCActionBlock)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LCThread</span> : <span class="title">NSThread</span></span></span><br><span class="line">- (<span class="keyword">void</span>)queueAction:(LCActionBlock)action;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LCThread.m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"LCThread.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LCThread</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span>&lt;LCActionBlock&gt; *actions;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSObject</span> *mutex;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LCThread</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _actions = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        _mutex   = [<span class="built_in">NSObject</span> new];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)queueAction:(LCActionBlock)action &#123;</span><br><span class="line">    <span class="keyword">@synchronized</span>(<span class="keyword">self</span>.mutex) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.actions addObject:[action <span class="keyword">copy</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    	  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">		    <span class="keyword">@synchronized</span>(<span class="keyword">self</span>.mutex) &#123;</span><br><span class="line">		        <span class="built_in">NSArray</span>&lt;LCActionBlock&gt; *actions = [<span class="keyword">self</span>.actions <span class="keyword">copy</span>];</span><br><span class="line">		        [<span class="keyword">self</span>.actions removeAllObjects];</span><br><span class="line">		        </span><br><span class="line">		        [actions enumerateObjectsUsingBlock:^(LCActionBlock  _Nonnull action, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">		            <span class="keyword">@try</span> &#123;</span><br><span class="line">		                action();</span><br><span class="line">		            &#125; <span class="keyword">@catch</span>(<span class="built_in">NSException</span> *error) &#123;</span><br><span class="line">		                <span class="built_in">NSLog</span>(<span class="string">@"error occurred: %@"</span>, error);</span><br><span class="line">		            &#125;</span><br><span class="line">		        &#125;];</span><br><span class="line">		    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.3</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 主界面代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.thread = [LCThread new];</span><br><span class="line">    <span class="keyword">self</span>.thread.name = <span class="string">@"myThread"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)onButtonTapped:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span>.thread queueAction:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Execution in thread [%@]"</span>, [<span class="built_in">NSThread</span> currentThread].name);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"saving video clips"</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在点击按钮，可以看到<code>video clips</code>正确地在我们创建的线程中调用，基本达到我们让保存视频的代码在后台线程执行的目的。但是这种方法有缺点：</p>
<ul>
<li>为了让线程一直运行但又不占满CPU时间，我们引入了<code>[NSThread sleepForTimeInterval:0.3]</code>，人为地让线程“活着”</li>
<li>即使<code>actions</code>为空，线程也需要从休眠中醒来检查还有没有需要处理的<code>action</code>，带来了无意义的消耗</li>
<li>无法随心所欲地唤醒线程，只能被动等待线程休眠足够长的时间</li>
<li>无法对<code>LCThread</code>使用<code>performSelector:onThread:withObject:waitUntilDone</code>等方法</li>
</ul>
<p>为了解决包括这个例子遇到的问题，苹果引入了<code>Runloop</code>的实现。</p>
<h2 id="Runloop"><a href="#Runloop" class="headerlink" title="Runloop"></a>Runloop</h2><p>现在再来拜读一下苹果对<code>Runloop</code>的解释</p>
<blockquote>
<p>Run loops are part of the fundamental infrastructure associated with threads. A run loop is an event processing loop that you use to schedule work and coordinate the receipt of incoming events. The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none.</p>
</blockquote>
<p>这不正是我们想要的么？当有工作需要线程做的时候，就让它干活，不需要它的时候，就让它休息去。“召之即来挥之即去”，在休眠时几乎不占用系统资源。</p>
<h3 id="尝试使用Runloop"><a href="#尝试使用Runloop" class="headerlink" title="尝试使用Runloop"></a>尝试使用Runloop</h3><p>苹果不允许直接创建<code>Runloop</code>，它只提供了两个自动获取的函数：<code>CFRunloopGetMain()</code>和<code>CFRunloopGetCurrent()</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 全局的Dictionary，key 是 pthread_t， value 是 CFRunLoopRef</span></span><br><span class="line"><span class="keyword">static</span> CFMutableDictionaryRef loopsDic;</span><br><span class="line"><span class="comment">/// 访问 loopsDic 时的锁</span></span><br><span class="line"><span class="keyword">static</span> CFSpinLock_t loopsLock;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/// 获取一个 pthread 对应的 RunLoop。</span></span><br><span class="line">CFRunLoopRef _CFRunLoopGet(<span class="keyword">pthread_t</span> thread) &#123;</span><br><span class="line">    OSSpinLockLock(&amp;loopsLock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!loopsDic) &#123;</span><br><span class="line">        <span class="comment">// 第一次进入时，初始化全局Dic，并先为主线程创建一个 RunLoop。</span></span><br><span class="line">        loopsDic = CFDictionaryCreateMutable();</span><br><span class="line">        CFRunLoopRef mainLoop = _CFRunLoopCreate();</span><br><span class="line">        CFDictionarySetValue(loopsDic, pthread_main_thread_np(), mainLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 直接从 Dictionary 里获取。</span></span><br><span class="line">    CFRunLoopRef loop = CFDictionaryGetValue(loopsDic, thread));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!loop) &#123;</span><br><span class="line">        <span class="comment">/// 取不到时，创建一个</span></span><br><span class="line">        loop = _CFRunLoopCreate();</span><br><span class="line">        CFDictionarySetValue(loopsDic, thread, loop);</span><br><span class="line">        <span class="comment">/// 注册一个回调，当线程销毁时，顺便也销毁其对应的 RunLoop。</span></span><br><span class="line">        _CFSetTSD(..., thread, loop, __CFFinalizeRunLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    OSSpinLockUnLock(&amp;loopsLock);</span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _CFRunLoopGet(pthread_main_thread_np());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetCurrent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _CFRunLoopGet(pthread_self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在就让我们在创建的线程中使用它吧</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.videoClips = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Execution in thread [%@]"</span>, [<span class="built_in">NSThread</span> currentThread].name);</span><br><span class="line">        [[<span class="built_in">NSRunLoop</span> currentRunLoop] run];</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">self</span>.thread.name = <span class="string">@"myThread"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)onButtonTapped:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(persistVideoClips:) onThread:<span class="keyword">self</span>.thread withObject:[<span class="keyword">self</span>.videoClips <span class="keyword">copy</span>] waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)persistVideoClips:(<span class="built_in">NSArray</span> *)clips &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"saving video clips"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>啊啊啊~！按照我们预想的结果，运行以后每次点击屏幕都应该有输出，但是实际上我们点击屏幕并没有任何效果，没有打印<code>saving video clips</code>。</p>
<p>根据<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW25" target="_blank" rel="noopener">苹果官方文档 - Starting the Run loop</a>的解释</p>
<blockquote>
<p>A run loop must have at least one input source or timer to monitor. If one is not attached, the run loop exits immediately.</p>
</blockquote>
<p>因为没有<code>input source</code>或者<code>timer source</code>，所以<code>Runloop</code>在启动后就立即退出了。</p>
<h3 id="深入Runloop"><a href="#深入Runloop" class="headerlink" title="深入Runloop"></a>深入Runloop</h3><p>不对Runloop一番了解，很难驾驭，所以我们就先来熟悉熟悉Runloop。Runloop在源代码中体现为一个对象，指的是<strong>NSRunloop</strong>或者<strong>CFRunloopRef</strong>，CFRunloopRef是在 CoreFoundation 框架内的，它提供了纯C的函数API，所有这些 API 都是线程安全的，而NSRunloop仅仅是CFRunloopRef的objective-c的封装，提供了面向对象的 API，但是这些 API 不是线程安全的。CFRunLoopRef 的代码是开源的，你可以在这里<a href="http://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">http://opensource.apple.com/tarballs/CF/</a>下载到整个 CoreFoundation 的源码来查看。我们接下来通过代码来了解它的内部逻辑(为了阅读方便，提取了重要的部分展示，如果不想阅读可以直接跳过看后面的流程图)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用kCFRunLoopDefaultMode启动Runloop</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFRunLoopRun</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;	<span class="comment">/* DOES CALLOUT */</span></span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, <span class="number">1.0e10</span>, <span class="literal">false</span>);</span><br><span class="line">        CHECK_FOR_FORK();</span><br><span class="line">    &#125; <span class="keyword">while</span> (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用指定的mode启动Runloop</span></span><br><span class="line"><span class="function">SInt32 <span class="title">CFRunLoopRunInMode</span><span class="params">(CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled)</span> </span>&#123;     <span class="comment">/* DOES CALLOUT */</span></span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="keyword">return</span> CFRunLoopRunSpecific(CFRunLoopGetCurrent(), modeName, seconds, returnAfterSourceHandled);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">SInt32 <span class="title">CFRunLoopRunSpecific</span><span class="params">(runloop, modeName, seconds, returnAfterSourceHandled)</span> </span>&#123;     <span class="comment">/* DOES CALLOUT */</span></span><br><span class="line">    <span class="keyword">if</span> (__CFRunLoopIsDeallocating(runloop)) </span><br><span class="line">        <span class="keyword">return</span> kCFRunLoopRunFinished;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//首先根据modeName找到对应的mode</span></span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(runloop, modeName, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果mode为空，或者mode里面没有[sources,timers,observers]直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == currentMode || __CFRunLoopModeIsEmpty(runloop, currentMode, runloop-&gt;_currentMode)) &#123;</span><br><span class="line">    	<span class="keyword">return</span> kCFRunLoopRunFinished;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> result = kCFRunLoopRunFinished;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知observers，即将进入loop</span></span><br><span class="line">	<span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) </span><br><span class="line">        __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopEntry);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用内部函数进入loop</span></span><br><span class="line">	result = __CFRunLoopRun(runloop, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知observers，Runloop即将退出</span></span><br><span class="line">	<span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopExit )</span><br><span class="line">        __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopExit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入loop的内部函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int32_t</span> __CFRunLoopRun(runloop, currentMode, seconds, stopAfterHandle) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> retVal = <span class="number">0</span>;</span><br><span class="line">    Boolean isTimerSource = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//获得timer的port</span></span><br><span class="line">    <span class="keyword">mach_port_name_t</span> timerPort = MACH_PORT_NULL;</span><br><span class="line">    <span class="keyword">if</span> (runloop-&gt;_queue) &#123;</span><br><span class="line">        timerPort = _dispatch_runloop_root_queue_get_port_4CF(runloop-&gt;_queue);</span><br><span class="line">        <span class="keyword">if</span> (!timerPort) &#123;</span><br><span class="line">            CRASH(<span class="string">"Unable to get port for run loop mode queue (%d)"</span>, <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 2. 通知 Observers: RunLoop 即将触发 Timer 回调。</span></span><br><span class="line">        __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeTimers);</span><br><span class="line">        <span class="comment">// 3. 通知 Observers: RunLoop 即将触发 Source0 (非port) 回调。</span></span><br><span class="line">        __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeSources);</span><br><span class="line">        <span class="comment">// 执行被加入的block</span></span><br><span class="line">        __CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line">        <span class="comment">// 4. RunLoop 触发 Source0 (非port) 回调。</span></span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(runloop, currentMode, stopAfterHandle);</span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">            __CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 如果有 Source1 (基于port) 处于 ready 状态，直接处理这个 Source1 然后跳转去9</span></span><br><span class="line">        <span class="keyword">if</span> (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</span><br><span class="line">            msg = (<span class="keyword">mach_msg_header_t</span> *)msg_buffer;</span><br><span class="line">            <span class="keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort, <span class="number">0</span>, &amp;voucherState, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知 Observers: RunLoop的线程即将进入休眠</span></span><br><span class="line">        <span class="keyword">if</span> (!sourceHandledThisLoop) &#123;</span><br><span class="line">            __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeWaiting);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 调用 mach_msg 等待接受 mach_port 的消息。线程将进入休眠, 直到被下面某一个事件唤醒。</span></span><br><span class="line">        <span class="comment">// • 一个基于 port 的Source 的事件。</span></span><br><span class="line">        <span class="comment">// • 一个 Timer 到时间了</span></span><br><span class="line">        <span class="comment">// • RunLoop 自身的超时时间到了</span></span><br><span class="line">        <span class="comment">// • 被其他什么调用者手动唤醒</span></span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort, poll ? <span class="number">0</span> : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line"></span><br><span class="line">        isTimerSource = timerPort != MACH_PORT_NULL &amp;&amp; livePort == timerPort;</span><br><span class="line">        <span class="comment">// 8. 通知 Observers: Runloop的线程刚刚被唤醒了</span></span><br><span class="line">        __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">    handle_msg:</span><br><span class="line">        <span class="comment">// 9.1 如果是timer唤醒，触发这个Timer的回调。</span></span><br><span class="line">        <span class="keyword">if</span>(isTimerSource) &#123;</span><br><span class="line">            __CFRunLoopDoTimers(runloop, currentMode, mach_absolute_time()</span><br><span class="line">        <span class="comment">//9.2 如果是main dispatch的唤醒，执行block</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(msg_is_dispatch) &#123;</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        <span class="comment">//9.3 如果一个 Source1 (基于port) 唤醒，处理source1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CFRunLoopSourceRef source1 = __CFRunLoopModeFindSourceForMachPort(runloop, currentMode, livePort);</span><br><span class="line">            sourceHandledThisLoop = __CFRunLoopDoSource1(runloop, currentMode, source1, msg);</span><br><span class="line">            <span class="keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">                mach_msg(reply, MACH_SEND_MSG, reply);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  再次确保是否有同步的方法需要调用</span></span><br><span class="line">        __CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">        	<span class="comment">// 进入loop时参数说处理完事件就返回。</span></span><br><span class="line">	       retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">           <span class="comment">// 超出传入参数标记的超时时间了</span></span><br><span class="line">           retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(runloop)) &#123;</span><br><span class="line">           <span class="comment">// 被外部调用者强制停止了</span></span><br><span class="line">           retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentMode-&gt;_stopped) &#123;</span><br><span class="line">        	<span class="comment">// currentMode 被强制停止，调用内部_CFRunLoopStopMode</span></span><br><span class="line">        	currentMode-&gt;_stopped = <span class="literal">false</span>;</span><br><span class="line">        	retVal = kCFRunLoopRunStopped;</span><br><span class="line">		 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(runloop, currentMode)) &#123;</span><br><span class="line">		 	<span class="comment">// source/timer/observer一个都没有了</span></span><br><span class="line">		 	retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="number">0</span> == retVal);</span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的伪代码可以看到，实际上Runloop就是内部是一个do-while调用的函数。这个函数管理线程需要处理的事件和消息，并在没有处理消息时休眠以避免占用系统资源，在有消息到来时立刻被唤醒。线程执行了<code>Runloop</code>后，其内部就会一直处于<code>接收消息-&gt;休眠-&gt;处理消息</code>的循环中，直到循环结束条件满足才会退出，结束线程。</p>
<p>下图展示了Runloop运行时的关键流程：</p>
<p><img src="http://ot51d7lis.bkt.clouddn.com/Runloop0.png" alt=""></p>
<p>通过代码和流程图我们有了初步的了解，但是还是有种神秘的感觉，别急，接下来就为您一一介绍什么是mode，source, observers和callouts。</p>
<h4 id="Runloop-modes"><a href="#Runloop-modes" class="headerlink" title="Runloop modes"></a>Runloop modes</h4><p>从源码很容易看出，Runloop总是运行在某种特定的CFRunLoopModeRef下，每次运行<strong>CFRunLoopRun</strong>函数时必须指定一种Mode，这个mode称为<strong>current mode</strong>。通过<strong>CFRunloopRef</strong>的结构体可以看出，一个Runloop可以包含N个modes，每个mode又可以包含若干个<strong>Sources/Timers/Observers</strong>。当切换Mode时必须退出<strong>current mode</strong>，然后再重新进入。</p>
<p><img src="http://ot51d7lis.bkt.clouddn.com/RunloopModes.png" alt=""> </p>
<p>CFRunloopMode和CFRunloop的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">	 CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;	<span class="comment">/* must have the run loop locked before locking this */</span></span><br><span class="line">    CFStringRef _name;</span><br><span class="line">    Boolean _stopped;</span><br><span class="line">    <span class="keyword">char</span> _padding[<span class="number">3</span>];</span><br><span class="line">    CFMutableSetRef _sources0; <span class="comment">// source0</span></span><br><span class="line">    CFMutableSetRef _sources1; <span class="comment">// source1</span></span><br><span class="line">    CFMutableArrayRef _observers;</span><br><span class="line">    CFMutableArrayRef _timers;</span><br><span class="line">    CFMutableDictionaryRef _portToV1SourceMap;</span><br><span class="line">    __CFPortSet _portSet;</span><br><span class="line">    CFIndex _observerMask;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">    <span class="keyword">dispatch_source_t</span> _timerSource;</span><br><span class="line">    <span class="keyword">dispatch_queue_t</span> _queue;</span><br><span class="line">    Boolean _timerFired; <span class="comment">// set to true by the source when a timer has fired</span></span><br><span class="line">    Boolean _dispatchTimerArmed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_MK_TIMER_TOO</span></span><br><span class="line">    <span class="keyword">mach_port_t</span> _timerPort;</span><br><span class="line">    Boolean _mkTimerArmed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">    DWORD _msgQMask;</span><br><span class="line">    <span class="keyword">void</span> (*_msgPump)(<span class="keyword">void</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">uint64_t</span> _timerSoftDeadline; <span class="comment">/* TSR */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> _timerHardDeadline; <span class="comment">/* TSR */</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;			<span class="comment">/* locked for accessing mode list */</span></span><br><span class="line">    __CFPort _wakeUpPort;			<span class="comment">// used for CFRunLoopWakeUp </span></span><br><span class="line">    Boolean _unused;</span><br><span class="line">    <span class="keyword">volatile</span> _per_run_data *_perRunData;              <span class="comment">// reset for runs of the run loop</span></span><br><span class="line">    <span class="keyword">pthread_t</span> _pthread;</span><br><span class="line">    <span class="keyword">uint32_t</span> _winthread;</span><br><span class="line">    CFMutableSetRef _commonModes;</span><br><span class="line">    CFMutableSetRef _commonModeItems;</span><br><span class="line">    CFRunLoopModeRef _currentMode;</span><br><span class="line">    CFMutableSetRef _modes;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_tail</span>;</span></span><br><span class="line">    CFAbsoluteTime _runTime;</span><br><span class="line">    CFAbsoluteTime _sleepTime;</span><br><span class="line">    CFTypeRef _counterpart;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="Common-Modes"><a href="#Common-Modes" class="headerlink" title="Common Modes"></a>Common Modes</h5><p>一个 Mode 可以将自己标记为<code>&quot;Common&quot;</code>属性（通过将其 ModeName 添加到RunLoop的 <code>_commonModes</code> 中）。每当 RunLoop的内容发生变化时，RunLoop都会自动将_commonModeItems里的 Source/Observer/Timer 同步到具有 <code>“Common”</code> 标记的所有Mode里。</p>
<h6 id="应用场景举例："><a href="#应用场景举例：" class="headerlink" title="应用场景举例："></a>应用场景举例：</h6><p>主线程的RunLoop里有两个预置的 Mode：<code>kCFRunLoopDefault    Mode</code> 和 <code>UITrackingRunLoopMode</code>。这两个 Mode 都已经被标记为”Common”属性。<code>DefaultMode</code> 是 App 平时所处的状态，<code>TrackingRunLoopMode</code> 是追踪 ScrollView 滑动时的状态。当你创建一个 Timer 并加到 DefaultMode时，Timer会得到重复回调，但此时滑动一个TableView时，RunLoop会将 mode 切换为 <code>TrackingRunLoopMode</code>，这时 Timer 就不会被回调，并且也不会影响到滑动操作。如果你想让这个Timer，在两个 Mode 中都能得到回调，有三种办法：</p>
<ul>
<li>将这个<code>Timer</code>分别加入这两个 Mode</li>
<li>将<code>Timer</code>加入到顶层的 RunLoop 的 “commonModeItems” 中。”commonModeItems” 被 RunLoop 自动更新到所有具有”Common”属性的 Mode 里去</li>
<li>将<code>Timer</code>加入到kCFRunLoopCommonModes（后面小节会提到）里面</li>
</ul>
<h5 id="常见modes介绍"><a href="#常见modes介绍" class="headerlink" title="常见modes介绍"></a>常见modes介绍</h5><ul>
<li><code>NSDefaultRunLoopMode</code>：App的默认 Mode。这个mode应该用在线程默认、空闲和等待事件时。</li>
<li><code>UITrackingRunLoopMode</code>：界面跟踪 Mode，用于 ScrollView 追踪触摸滑动，保证界面滑动时不受其他 Mode 影响</li>
<li><code>UIInitializationRunLoopMode</code>： 在刚启动 App 时第进入的第一个 Mode，启动完成后就不再使用</li>
<li><code>GSEventReceiveRunLoopMode</code>： 接受系统事件的内部 Mode，通常用不到</li>
<li><code>NSRunLoopCommonModes</code>：通过将对象（timer/source/observer）通过<code>CFRunLoopAddCommonMode</code>加入到<code>Runloop</code>后，能够被同步到所有标记为<code>&quot;common&quot;</code>的modes里</li>
</ul>
<h5 id="常用接口"><a href="#常用接口" class="headerlink" title="常用接口"></a>常用接口</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///将一个mode加入到common modes的set里面</span></span><br><span class="line">CFRunLoopAddCommonMode(CFRunLoopRef runloop, CFStringRef modeName);</span><br><span class="line"><span class="comment">///以指定mode在当前线程启动runloop</span></span><br><span class="line"><span class="function">CFRunLoopRunResult <span class="title">CFRunLoopRunInMode</span><span class="params">(CFRunLoopMode mode, CFTimeInterval seconds, Boolean returnAfterSourceHandled)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">///添加一个source到指定的mode</span></span><br><span class="line">CFRunLoopAddSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);</span><br><span class="line"><span class="comment">///判断指定的mode是否包含传入的source</span></span><br><span class="line">CFRunLoopContainsSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFRunLoopMode mode);</span><br><span class="line"><span class="comment">///将一个source从指定mode中移除</span></span><br><span class="line">CFRunLoopRemoveSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);</span><br><span class="line"></span><br><span class="line"><span class="comment">///添加一个observer到指定的mode</span></span><br><span class="line">CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);</span><br><span class="line"><span class="comment">///判断指定的mode是否包含传入的observer</span></span><br><span class="line">CFRunLoopContainsObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFRunLoopMode mode);</span><br><span class="line"><span class="comment">///将一个observer从指定mode中移除</span></span><br><span class="line">CFRunLoopRemoveObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);</span><br><span class="line"></span><br><span class="line"><span class="comment">///添加一个timer到指定的mode</span></span><br><span class="line">CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);</span><br><span class="line"><span class="comment">///将timer从指定的mode中移除</span></span><br><span class="line">CFRunLoopRemoveTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);</span><br></pre></td></tr></table></figure>
<h4 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h4><p>Sources是用来唤醒Runloop的线程的</p>
<h5 id="CFRunLoopSourceRef"><a href="#CFRunLoopSourceRef" class="headerlink" title="CFRunLoopSourceRef"></a>CFRunLoopSourceRef</h5><p>CFRunLoopSourceRef对应两种源: source0和source1。其中Source1和Timer source都属于端口事件源，不同的是所有的Timer都共用一个端口，而每个source1都有自己的端口。</p>
<ul>
<li>source0：负责app内部事件，只包含一个回调函数指针，不能主动触发事件。使用时，需要先调用<strong>CFRunLoopSourceSignal(source)</strong>,将这个Source标记为待处理，然后手动调用 <strong>CFRunLoopWakeUp(runloop)</strong> 来唤醒 RunLoop，让其处理这个事件</li>
<li>Source1：除了包含回调指针外还包含一个<strong>mach port</strong>，和source0不同，source1可以监听系统端口或者和其他线程互发消息，它能够主动唤醒Runloop。</li>
</ul>
<h5 id="CFRunLoopTimerRef"><a href="#CFRunLoopTimerRef" class="headerlink" title="CFRunLoopTimerRef"></a>CFRunLoopTimerRef</h5><p>Timer会在一个预设的时间内向线程传递<strong>同步</strong>消息。Timer是与Runloop的mode来联系在一起的，如果Timer所在的mode没有被Runloop所使用，那么它将不会被调用直到Runloop切换到Timer所属的mode。同样地，如果Timer在Runloop处理事务过程中触发了，那就需要等到Runloop下一次loop才能执行Timer的回调了。如果Runloop压根就没有跑起来，那么Timer无论如何也不会触发的。</p>
<h4 id="Observers"><a href="#Observers" class="headerlink" title="Observers"></a>Observers</h4><p>与sources相反，Runloop observers是用来观察Runloop的状态变化的。当Runloop状态改变，可以通过observers的回调接收到相应的变化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopObserver</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFRunLoopRef _runLoop;</span><br><span class="line">    CFIndex _rlCount;</span><br><span class="line">    CFOptionFlags _activities;      <span class="comment">/* immutable */</span></span><br><span class="line">    CFIndex _order;         <span class="comment">/* immutable */</span></span><br><span class="line">    CFRunLoopObserverCallBack _callout; <span class="comment">/* immutable */</span></span><br><span class="line">    CFRunLoopObserverContext _context;  <span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以观察到的状态有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Run Loop Observer Activities */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">    kCFRunLoopEntry = (<span class="number">1U</span>L &lt;&lt; <span class="number">0</span>), <span class="comment">// 进入RunLoop </span></span><br><span class="line">    kCFRunLoopBeforeTimers = (<span class="number">1U</span>L &lt;&lt; <span class="number">1</span>), <span class="comment">// 即将开始Timer处理</span></span><br><span class="line">    kCFRunLoopBeforeSources = (<span class="number">1U</span>L &lt;&lt; <span class="number">2</span>), <span class="comment">// 即将开始Source处理</span></span><br><span class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">5</span>), <span class="comment">// 即将进入休眠</span></span><br><span class="line">    kCFRunLoopAfterWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">6</span>), <span class="comment">//从休眠状态唤醒</span></span><br><span class="line">    kCFRunLoopExit = (<span class="number">1U</span>L &lt;&lt; <span class="number">7</span>), <span class="comment">//退出RunLoop</span></span><br><span class="line">    kCFRunLoopAllActivities = <span class="number">0x0FFFFFFF</span>U</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Call-out"><a href="#Call-out" class="headerlink" title="Call out"></a>Call out</h4><p>在开发过程中几乎所有的操作都是通过Call out进行回调的(无论是Observer的状态通知还是Timer、Source的处理)，而系统在回调时通常使用如下几个函数进行回调(换句话说你的代码其实最终都是通过下面几个函数来负责调用的，即使你自己监听Observer也会先调用下面的函数然后间接通知你，所以在调用堆栈中经常看到这些函数)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__() __attribute__((noinline));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__() __attribute__((noinline));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__() __attribute__((noinline));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__() __attribute__((noinline));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__() __attribute__((noinline));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__() __attribute__((noinline));</span><br></pre></td></tr></table></figure>
<h4 id="Runloop的休眠"><a href="#Runloop的休眠" class="headerlink" title="Runloop的休眠"></a>Runloop的休眠</h4><p>RunLoop最核心的事情就是保证线程在没有消息时休眠以避免占用系统资源，有消息时能够及时唤醒。RunLoop的这个机制完全依靠系统内核来完成，具体来说是苹果操作系统核心组件Darwin中的Mach来完成的（<a href="https://opensource.apple.com/" target="_blank" rel="noopener">Darwin</a>是开源的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  Routine:    mach_msg</span></span><br><span class="line"><span class="comment"> *  Purpose:</span></span><br><span class="line"><span class="comment"> *      Send and/or receive a message.  If the message operation</span></span><br><span class="line"><span class="comment"> *      is interrupted, and the user did not request an indication</span></span><br><span class="line"><span class="comment"> *      of that fact, then restart the appropriate parts of the</span></span><br><span class="line"><span class="comment"> *      operation silently (trap version does not restart).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__WATCHOS_PROHIBITED __TVOS_PROHIBITED</span><br><span class="line"><span class="function"><span class="keyword">extern</span> mach_msg_return_t    <span class="title">mach_msg</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_msg_header_t</span> *msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_msg_option_t</span> option,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_msg_size_t</span> send_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_msg_size_t</span> rcv_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_port_name_t</span> rcv_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_msg_timeout_t</span> timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mach_port_name_t</span> notify)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="使用Runloop"><a href="#使用Runloop" class="headerlink" title="使用Runloop"></a>使用Runloop</h3><h4 id="使用NSMachPort作为source-source1"><a href="#使用NSMachPort作为source-source1" class="headerlink" title="使用NSMachPort作为source (source1)"></a>使用NSMachPort作为source (source1)</h4><p>经过上一节的分析，已经对Runloop有了深入的了解。现在就能修改之前的例子，让它能正常工作起来了。为了让Runloop不退出，最简单的方式就是创建一个NSMachPort添加到Runloop里面。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.videoClips = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSRunLoop</span> *runloop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">        [runloop addPort:[<span class="built_in">NSMachPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">        [runloop run];</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">self</span>.thread.name = <span class="string">@"myThread"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)onButtonTapped:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(persistVideoClips:) onThread:<span class="keyword">self</span>.thread withObject:[<span class="keyword">self</span>.videoClips <span class="keyword">copy</span>] waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)persistVideoClips:(<span class="built_in">NSArray</span> *)clips &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Execution in thread [%@], saving video clips"</span>, [<span class="built_in">NSThread</span> currentThread].name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后，点击按钮，可以看到控制台输出<code>Execution in thread [myThread], saving video clips</code>。</p>
<h4 id="自定义source-Source0"><a href="#自定义source-Source0" class="headerlink" title="自定义source (Source0)"></a>自定义source (Source0)</h4><p>我们把例子用source0的方式修改一下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> runloopSourceScheduleRoutine(<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> runloop, <span class="built_in">CFRunLoopMode</span> mode) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Schedule routine: source is added to runloop"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> runloopSourceCancelRoutine(<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> runloop, <span class="built_in">CFRunLoopMode</span> mode) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Cancel Routine: source removed from runloop"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> runloopSourcePerformRoutine(<span class="keyword">void</span> *info) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"In thread [%@], Perform Routine: source has fired"</span>, [<span class="built_in">NSThread</span> currentThread].name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyThread</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CFRunLoopSourceRef</span> source;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CFRunLoopRef</span> runloop;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyThread</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">self</span>.source = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">self</span>.runloop = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSRunLoop</span> *runloop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">        <span class="keyword">self</span>.runloop = [runloop getCFRunLoop];</span><br><span class="line">        <span class="built_in">CFRunLoopSourceContext</span> context = &#123;<span class="number">0</span>, (__bridge <span class="keyword">void</span> *)(<span class="keyword">self</span>), <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, runloopSourceScheduleRoutine, runloopSourceCancelRoutine, runloopSourcePerformRoutine &#125;;</span><br><span class="line">        <span class="keyword">self</span>.source = <span class="built_in">CFRunLoopSourceCreate</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;context);</span><br><span class="line">        <span class="built_in">CFRunLoopAddSource</span>(<span class="keyword">self</span>.runloop, <span class="keyword">self</span>.source, kCFRunLoopDefaultMode);</span><br><span class="line">        [runloop run];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)triggerSource0 &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopSourceSignal</span>(<span class="keyword">self</span>.source);</span><br><span class="line">    <span class="built_in">CFRunLoopWakeUp</span>(<span class="keyword">self</span>.runloop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ViewController </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.videoClips = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">self</span>.thread = [MyThread new];</span><br><span class="line">    <span class="keyword">self</span>.thread.name = <span class="string">@"myThread"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)buttonTapped:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span>.thread triggerSource0];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用Observer"><a href="#使用Observer" class="headerlink" title="使用Observer"></a>使用Observer</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> addObserver(<span class="built_in">CFRunLoopRef</span> runloop) &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(</span><br><span class="line">                                                                       kCFAllocatorDefault,</span><br><span class="line">                                                                       kCFRunLoopAllActivities,</span><br><span class="line">                                                                       <span class="literal">YES</span>,</span><br><span class="line">                                                                       <span class="number">0</span>,</span><br><span class="line">       ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            kCFRunLoopEntry = (1UL &lt;&lt; 0),          进入工作</span></span><br><span class="line"><span class="comment">            kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),   即将处理Timers事件</span></span><br><span class="line"><span class="comment">            kCFRunLoopBeforeSources = (1UL &lt;&lt; 2),  即将处理Source事件</span></span><br><span class="line"><span class="comment">            kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),  即将休眠</span></span><br><span class="line"><span class="comment">            kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),   被唤醒</span></span><br><span class="line"><span class="comment">            kCFRunLoopExit = (1UL &lt;&lt; 7),           退出RunLoop</span></span><br><span class="line"><span class="comment">            kCFRunLoopAllActivities = 0x0FFFFFFFU  监听所有事件</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="keyword">switch</span> (activity) &#123;</span><br><span class="line">               <span class="keyword">case</span> kCFRunLoopEntry:</span><br><span class="line">                   <span class="built_in">NSLog</span>(<span class="string">@"进入"</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> kCFRunLoopBeforeTimers:</span><br><span class="line">                   <span class="built_in">NSLog</span>(<span class="string">@"即将处理Timer事件"</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> kCFRunLoopBeforeSources:</span><br><span class="line">                   <span class="built_in">NSLog</span>(<span class="string">@"即将处理Source事件"</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> kCFRunLoopBeforeWaiting:</span><br><span class="line">                   <span class="built_in">NSLog</span>(<span class="string">@"即将休眠"</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> kCFRunLoopAfterWaiting:</span><br><span class="line">                   <span class="built_in">NSLog</span>(<span class="string">@"被唤醒"</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> kCFRunLoopExit:</span><br><span class="line">                   <span class="built_in">NSLog</span>(<span class="string">@"退出RunLoop"</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">  );</span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(runloop, observer, kCFRunLoopDefaultMode);</span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span> ,<span class="keyword">nonatomic</span>) <span class="built_in">NSTimer</span> *timer;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">2.0</span> repeats:<span class="literal">YES</span> block:^(<span class="built_in">NSTimer</span> * _Nonnull timer) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"timer tick"</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    addObserver(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>控制台打印的部分信息：</p>
<blockquote>
<p>2018-08-02 14:46:40.994863+0800 ObserverDemo[4707:559984] 被唤醒<br>2018-08-02 14:46:40.995346+0800 ObserverDemo[4707:559984] 即将处理Timer事件<br>2018-08-02 14:46:40.995468+0800 ObserverDemo[4707:559984] 即将处理Source事件<br>2018-08-02 14:46:40.995584+0800 ObserverDemo[4707:559984] 即将休眠<br>2018-08-02 14:46:41.584618+0800 ObserverDemo[4707:559984] 被唤醒<br>2018-08-02 14:46:41.584982+0800 ObserverDemo[4707:559984] timer tick<br>2018-08-02 14:46:41.585309+0800 ObserverDemo[4707:559984] 即将处理Timer事件<br>2018-08-02 14:46:41.585592+0800 ObserverDemo[4707:559984] 即将处理Source事件<br>2018-08-02 14:46:41.585810+0800 ObserverDemo[4707:559984] 即将休眠<br>2018-08-02 14:46:43.584045+0800 ObserverDemo[4707:559984] 被唤醒<br>2018-08-02 14:46:43.584247+0800 ObserverDemo[4707:559984] timer tick<br>2018-08-02 14:46:43.584424+0800 ObserverDemo[4707:559984] 即将处理Timer事件<br>2018-08-02 14:46:43.584539+0800 ObserverDemo[4707:559984] 即将处理Source事件<br>2018-08-02 14:46:43.584685+0800 ObserverDemo[4707:559984] 即将休眠<br>2018-08-02 14:46:45.584768+0800 ObserverDemo[4707:559984] 被唤醒<br>2018-08-02 14:46:45.585063+0800 ObserverDemo[4707:559984] timer tick<br>2018-08-02 14:46:45.585379+0800 ObserverDemo[4707:559984] 即将处理Timer事件<br>2018-08-02 14:46:45.585638+0800 ObserverDemo[4707:559984] 即将处理Source事件<br>2018-08-02 14:46:45.585864+0800 ObserverDemo[4707:559984] 即将休眠</p>
</blockquote>
<p>可以看到流程跟我们在深入Runloop分析的一样。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>苹果的<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html#//apple_ref/doc/uid/10000057i-CH1-SW1" target="_blank" rel="noopener">Threading Programming Guide</a></p>
<p>Kenshin的<a href="https://www.cnblogs.com/kenshincui/p/6823841.html" target="_blank" rel="noopener">iOS刨根问底-深入理解Runloop</a></p>
<p>ibireme的<a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">深入理解Runloop</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2018/07/16/javascript-get-style/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/16/javascript-get-style/" itemprop="url">获得运行时指定DOM元素的Style</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T13:08:42+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/16/javascript-get-style/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/16/javascript-get-style/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/16/javascript-get-style/" class="leancloud_visitors" data-flag-title="获得运行时指定DOM元素的Style">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="获得运行时指定DOM元素的Style"><a href="#获得运行时指定DOM元素的Style" class="headerlink" title="获得运行时指定DOM元素的Style"></a>获得运行时指定DOM元素的Style</h2><p>在工作中有时候需要获得指定DOM元素是否具有某种style，内联样式和层叠样式都需要检查，怎么做呢？直接上代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将字符串中的'-'开始的子字符串去掉'-'并替换为大写字母</span></span><br><span class="line"><span class="comment"> * 例如background-color,会被替换为backgroundColor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">camelize</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="regexp">/-(\w)/g</span>, <span class="function"><span class="keyword">function</span> (<span class="params">strMatch, p1</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p1.toUpperCase();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获得指定元素的指定style</span></span><br><span class="line"><span class="comment"> * @param elem DOM 元素</span></span><br><span class="line"><span class="comment"> * @param property style的名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStyle</span>(<span class="params">elem, property</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!elem || !property) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'elem or property should not be undefined or null.'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> value = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(elem.style)&#123;</span><br><span class="line">        value = elem.style[camelize(property)];<span class="comment">//先获取是否有内联样式</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 无内联样式，则获取层叠样式表计算后的样式</span></span><br><span class="line">        <span class="keyword">if</span> (!value || value === <span class="string">""</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">document</span>.defaultView &amp;&amp; <span class="built_in">document</span>.defaultView.getComputedStyle) &#123;</span><br><span class="line">                <span class="keyword">var</span> css = <span class="built_in">document</span>.defaultView.getComputedStyle(elem,<span class="literal">null</span>);</span><br><span class="line">                value = css ? css.getPropertyValue(property) : <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>camelize</code>方法将传入的style名称中的<code>-</code>替换掉，因为内联样式的名称中不包括它。如<code>getStyle</code>方法所体现的，优先在内联样式中查找，如果找到就返回，否则调用<code>defaultView</code>的<code>getComputedStyle</code>方法来获得层叠样式表中的style。</p>
<h3 id="defaultView"><a href="#defaultView" class="headerlink" title="defaultView"></a>defaultView</h3><p>什么是<code>defaultView</code>? 根据<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/defaultView" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Document/defaultView</a>所说：</p>
<blockquote>
<p>在浏览器中，该属性返回当前 document 对象所关联的 window 对象，如果没有，会返回 null。</p>
</blockquote>
<h3 id="getComputedStyle"><a href="#getComputedStyle" class="headerlink" title="getComputedStyle"></a>getComputedStyle</h3><blockquote>
<p>Window.getComputedStyle()方法返回一个对象，该对象在应用活动样式表并解析这些值可能包含的任何基本计算后报告元素的所有CSS属性的值。 私有的CSS属性值可以通过对象提供的API或通过简单地使用CSS属性名称进行索引来访问。</p>
</blockquote>
<p>参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getComputedStyle" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getComputedStyle</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2018/07/13/password-table/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/13/password-table/" itemprop="url">对抗反编译之使用密码表来保护代码中的字符串</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-13T12:30:24+08:00">
                2018-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向工程/" itemprop="url" rel="index">
                    <span itemprop="name">逆向工程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/13/password-table/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/13/password-table/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/13/password-table/" class="leancloud_visitors" data-flag-title="对抗反编译之使用密码表来保护代码中的字符串">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="对抗反编译之使用密码表来保护代码中的字符串"><a href="#对抗反编译之使用密码表来保护代码中的字符串" class="headerlink" title="对抗反编译之使用密码表来保护代码中的字符串"></a>对抗反编译之使用密码表来保护代码中的字符串</h2><p>在最近几个月的时间内，由于工作的关系，一直在对抗互联网的黑色产业，就是传说中的众多刷机工作室。他们拥有数量众多的越狱设备，只要有利可图，就会对目标ipa进行破解来达到获利的目的。</p>
<p>众所周知，苹果设备和app的安全性要比隔壁安卓高出许多，但这个是在有苹果爸爸设计的一系列安全保护措施下面，也就是在非越狱环境下。一旦app跑在越狱的环境下，并且开发者没有做任何保护措施的话，那就相当于裸奔了。</p>
<p>安全这个问题很大，我仅分享给大家工作中我学到的经验，之后我会一点一点更新我的blog，如果有更多时间，还有开源一些代码到我的github上。今天先来谈谈程序中字符串的安全问题。</p>
<h3 id="一般程序中对敏感字符串处理的例子"><a href="#一般程序中对敏感字符串处理的例子" class="headerlink" title="一般程序中对敏感字符串处理的例子"></a>一般程序中对敏感字符串处理的例子</h3><p>一般程序员因为工期赶或者没有安全性上的顾虑，对app中敏感的字符串，尤其是跟自家服务器通信的私钥啦，身份验证key啦，都是用一个全局字符串常量来保存，就跟下面代码一样：</p>
<h4 id="secret-h-文件"><a href="#secret-h-文件" class="headerlink" title="secret.h 文件"></a>secret.h 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern NSString * const secretKey;</span><br></pre></td></tr></table></figure>
<h4 id="secret-m-文件"><a href="#secret-m-文件" class="headerlink" title="secret.m 文件"></a>secret.m 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSString * const secretKey = @&quot;nzPHmNrbjuVOO7dX&quot;;</span><br></pre></td></tr></table></figure>
<p>这样做的结果是，图谋不轨的人只要利用反编译工具就能够轻而易举获得app中任意敏感信息，对公司利益造成巨大损失。有不少反编译工具可以使用，例如<a href="https://www.jianshu.com/p/10873c5c1e08" target="_blank" rel="noopener">Hopper Disassembler</a>, <a href="https://www.hex-rays.com/products/ida/" target="_blank" rel="noopener">IDA Pro</a>等工具。</p>
<h3 id="如何有效防止字符串泄露敏感信息"><a href="#如何有效防止字符串泄露敏感信息" class="headerlink" title="如何有效防止字符串泄露敏感信息"></a>如何有效防止字符串泄露敏感信息</h3><p>办法肯定有不少，我这里分享我们自己在用的办法。</p>
<ol>
<li>基本想法就是预先配置好一个字符表</li>
<li>然后将需要隐藏的敏感信息字符串一个字符一个字符从表里查到出相应的位置记下来</li>
<li>程序使用的时候跟第2步的位置组成的字符数组，把字符串还原出来</li>
</ol>
<h4 id="代码分享"><a href="#代码分享" class="headerlink" title="代码分享"></a>代码分享</h4><blockquote>
<p>代码在iOS和android两个平台都能够使用</p>
</blockquote>
<h5 id="生成密码表"><a href="#生成密码表" class="headerlink" title="生成密码表"></a>生成密码表</h5><p>假设我们现在预先配置的字符表为<code>ABCD123456</code></p>
<p>先通过这个网站<a href="http://www.online-toolz.com/tools/text-hex-convertor.php" target="_blank" rel="noopener">http://www.online-toolz.com/tools/text-hex-convertor.php</a>获得这个字符串的hex code <code>41424344313233343536</code>，然后在程序中声明一个数组<code>hex_table</code>来存储它（见下面的代码）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PasswordTable.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//source string: ABCD123456</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint8_t</span> hex_table[TABLE_SIZE] = &#123;</span><br><span class="line">    <span class="number">0x41</span>,<span class="number">0x42</span>,<span class="number">0x43</span>,<span class="number">0x44</span>,<span class="number">0x31</span>,<span class="number">0x32</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x35</span>,<span class="number">0x36</span> &#125;;</span><br></pre></td></tr></table></figure>
<h5 id="查询并输出字符在密码表中的位置"><a href="#查询并输出字符在密码表中的位置" class="headerlink" title="查询并输出字符在密码表中的位置"></a>查询并输出字符在密码表中的位置</h5><p>使用下面的代码可以在<code>console</code>看到对应的数组，将它copy下来，例如我们这里传入’BCD456’后生成对应的int数组<code>len = 6 { 1, 2, 3, 7, 8, 9, }</code>，把这个数组记下来。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PasswordTable.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * lookup magic numbers in terms of the given str based </span></span><br><span class="line"><span class="comment"> * on magic table.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lookupMagics</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * str, <span class="keyword">size_t</span> str_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"len = %li &#123;"</span>, str_len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; str_len; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TABLE_SIZE; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hex_table[i] == str[j]) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">" %i,"</span>, i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" &#125;\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="从密码表生成原字符串"><a href="#从密码表生成原字符串" class="headerlink" title="从密码表生成原字符串"></a>从密码表生成原字符串</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PasswordTable.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TABLE_SIZE 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Convert integer array to string based on built-in hex table.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param array       integer array.</span></span><br><span class="line"><span class="comment"> @param arr_len     length of the array.</span></span><br><span class="line"><span class="comment"> @param buffer      string buffer for receiving result, make sure it was alloced.</span></span><br><span class="line"><span class="comment"> @param buffer_len  length of the buffer.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @return            0 success, -1 if buffer_len is less than arr_len.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">convertMagics2String</span><span class="params">(<span class="keyword">int</span> * <span class="built_in">array</span>, <span class="keyword">size_t</span> arr_len, <span class="keyword">char</span> * buffer, <span class="keyword">size_t</span> buffer_len)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PasswordTable.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//source string: ABCD123456</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint8_t</span> hex_table[TABLE_SIZE] = &#123;</span><br><span class="line">    <span class="number">0x41</span>,<span class="number">0x42</span>,<span class="number">0x43</span>,<span class="number">0x44</span>,<span class="number">0x31</span>,<span class="number">0x32</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x35</span>,<span class="number">0x36</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">convertMagics2String</span><span class="params">(<span class="keyword">int</span> * <span class="built_in">array</span>, <span class="keyword">size_t</span> arr_len, <span class="keyword">char</span> * buffer, <span class="keyword">size_t</span> buffer_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer_len &lt;= arr_len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">void</span> *)buffer, <span class="number">0</span>, arr_len + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr_len; i++) &#123;</span><br><span class="line">        buffer[i] = hex_table[<span class="built_in">array</span>[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//main.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"PasswordTable.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> magics[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;;<span class="comment">//之前由调用lookupMagics生成的整形数组</span></span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">7</span>];</span><br><span class="line">    convertMagics2String(magics, <span class="number">6</span>, str, <span class="number">7</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"the source string is %s\n"</span>, str); <span class="comment">//将会打印: the source string is BCD456</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面代码中main函数的例子就是你在实际代码中的样子。这样做了以后，反编译工具就很难快速容易地通过字符串获得关键信息了，除非对方对你的代码抱有极大的兴趣，愿意花时间分析。</p>
<p>最后再多说一点，为了进一步加强安全性，建议对以上c函数进行混淆，将进一步加大反编译分析的难度。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2018/07/02/jenkins-fastlane-part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/02/jenkins-fastlane-part2/" itemprop="url">使用Fastlane和Jenkins构建自动打包系统 (Part 2)</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-02T10:05:14+08:00">
                2018-07-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/02/jenkins-fastlane-part2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/02/jenkins-fastlane-part2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/02/jenkins-fastlane-part2/" class="leancloud_visitors" data-flag-title="使用Fastlane和Jenkins构建自动打包系统 (Part 2)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Fastlane-match-使用已经存在的证书"><a href="#Fastlane-match-使用已经存在的证书" class="headerlink" title="Fastlane match 使用已经存在的证书"></a>Fastlane match 使用已经存在的证书</h2><p>经过第一部分的学习，<strong>Fastlane</strong>这个工具确实很好用，自动生成证书，自动打包，自动传到appstore，一切看上很完美。但是，在默认情况下，<strong>match</strong>是不能够使用已经存在的证书和provisiong profiles的，换句话说就是每次调用<strong>fastlane match</strong>的时候，如果发现git repo没有就会为你生成新的。显然，这个限制会让很多现有项目的开发者望而生畏。好在，我们有办法可以让它支持现有证，但是这个办法稍微有点麻烦，因为它不是自动的。</p>
<blockquote>
<p>如果你还未了解什么是fastlane，请先阅读<a href="http://gobodigo.com/2018/06/23/fastlane-jenkins/">使用Fastlane和Jenkins构建自动打包系统 (Part 1)</a></p>
</blockquote>
<h3 id="导出证书"><a href="#导出证书" class="headerlink" title="导出证书"></a>导出证书</h3><p>在我们开始使用现有的证书前，先得保证所有需要的证书和私钥都已经被导出并且保存在本地。</p>
<p><strong>首先</strong></p>
<p>打开<strong>keychain</strong>, 选择要将要在项目中使用的证书，然后选择导出</p>
<p><img src="http://ot51d7lis.bkt.clouddn.com/export_cert.png" alt=""></p>
<p>在<strong>File Format</strong>选择导出为.cer文件。</p>
<p><img src="http://ot51d7lis.bkt.clouddn.com/export_dialog.JPG" alt=""></p>
<p>然后，再次选择导出，在<strong>File Format</strong>选择导出为p12导出私钥（不要设置密码，因为如果设置了密码后，fastlane就无法导入私钥了）。</p>
<p>下一步就是去查找证书在apple developer portal的id了（后续需要以这个id来为证书和私钥命名），但是这个信息在管理后台是看不到的。这个时候，就需要借助<strong>fastlane</strong>内部直接使用的一个库<strong>Spaceship</strong>。</p>
<h3 id="使用Spaceship"><a href="#使用Spaceship" class="headerlink" title="使用Spaceship"></a>使用Spaceship</h3><p>在命令行输入<code>irb</code>打开一个交互式的ruby shell环境。</p>
<p>之后，输入<code>require &#39;spaceship&#39;</code>和回车，这个命令会将这个库导入到当前的shell环境中。接下来，输入下面这个命令来登录到apple developer portal：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Spaceship.login</span><br></pre></td></tr></table></figure>
<p>然后就是获取证书信息的命令，这里有两种方式，一种是获得全部的，另外一种是按照证书的类型来获取。</p>
<p>第一种，获取所有证书信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Spaceship.certificate.all</span><br></pre></td></tr></table></figure>
<p>第二种，获取指定类型的证书信息：</p>
<p><strong>获取开发证书</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Spaceship.certificate.development.all</span><br></pre></td></tr></table></figure>
<p><strong>获取发布证书</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Spaceship.certificate.production.all</span><br></pre></td></tr></table></figure>
<p><strong>证书信息例子</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;Spaceship::Portal::Certificate::Development </span><br><span class="line">	id=<span class="string">"TB48U5GPM8"</span>, </span><br><span class="line">	name=<span class="string">"iOS Development"</span>, </span><br><span class="line">	status=<span class="string">"Issued"</span>, </span><br><span class="line">	created=2018-06-29 10:35:08 UTC, </span><br><span class="line">	expires=2019-06-29 10:25:08 UTC, </span><br><span class="line">	owner_type=<span class="string">"teamMember"</span>, </span><br><span class="line">	owner_name=<span class="string">"owner name"</span>, </span><br><span class="line">	owner_id=<span class="string">"X9EZKD2K8B"</span>, </span><br><span class="line">	type_display_id=<span class="string">"6QPB9NHCEX"</span>, </span><br><span class="line">	can_download=<span class="literal">true</span>&gt;</span><br></pre></td></tr></table></figure>
<p>这个命令会列出证书所有的信息，而且很有可能会返回多个证书。这个时候，你需要仔细将其与本地证书的时间和过期对比，一致的就是你要找的证书信息。当你找到匹配的，就以证书信息的id来命名本地保存的相应的证书和私钥。</p>
<p>接下来我们需要将证书push到match使用的git repo上。</p>
<h3 id="Push-证书和Provision"><a href="#Push-证书和Provision" class="headerlink" title="Push 证书和Provision"></a>Push 证书和Provision</h3><p>在命令行输入下面的命令来准备一些需要用到的变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">irb(main):004:0&gt; require <span class="string">'match'</span></span><br><span class="line">=&gt; <span class="literal">true</span></span><br><span class="line">irb(main):005:0&gt; git_url=<span class="string">'git@github.com:path-to/the-encrypted-certs-repo.git'</span></span><br><span class="line">=&gt; <span class="string">"git@github.com:path-to/the-encrypted-certs-repo.git"</span></span><br><span class="line">irb(main):006:0&gt; shallow_clone = <span class="literal">false</span></span><br><span class="line">=&gt; <span class="literal">false</span></span><br><span class="line">irb(main):007:0&gt; manual_password = <span class="string">'password-to-decrypt-the-repo'</span></span><br><span class="line">=&gt; <span class="string">"password-to-decrypt-the-repo"</span></span><br><span class="line">irb(main):008:0&gt;</span><br></pre></td></tr></table></figure>
<p>接下来，我们需要使用下面的命令把存放证书的git repo给clone下来并且解密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">irb(main):005:0&gt; workspace = Match::GitHelper.clone(git_url, shallow_clone, manual_password: manual_password)</span><br><span class="line">[21:17:30]: Cloning remote git repo...</span><br><span class="line">[21:17:31]: 🔓  Successfully decrypted certificates repo</span><br><span class="line">=&gt; <span class="string">"/var/folders/5s/5cgmqxkx4fx6bllwgp1y5dlh000gp/T/d2018-0411-3701-148akjh"</span></span><br></pre></td></tr></table></figure>
<p>这个命令将repo clone到了<code>/var/folders/...</code>打开它。然后在这个文件夹里面，根据证书的类型来创建不同的文件夹：</p>
<ul>
<li>如果创建开发证书，则放到<code>certs/development</code>里面</li>
<li>如果是发布证书，则放到<code>certs/distribution</code>里面</li>
</ul>
<p>将证书和私钥都要对应放到上述的文件夹里面。</p>
<p>最后来处理<strong>provision profiles</strong>，首先你得从<strong>Apple developer portal</strong>下载所需要的<strong>provision profiles</strong>。下载完成后，根据不同的类型放入不同的文件夹，规则如下：</p>
<ul>
<li><strong>adhoc</strong>: <code>profiles/adhoc/AdHoc_&lt;appbundleid&gt;.mobileprovision</code></li>
<li><strong>appstore</strong>: <code>profiles/appstore/AppStore_&lt;appbundleid&gt;.mobileprovision</code></li>
<li><strong>development</strong>: <code>profiles/development/Development_&lt;appbundleid&gt;.mobileprovision</code></li>
</ul>
<p>做完这些后，现在我们来把证书和provision profiles推到git repo上去吧。执行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irb(main):006:0&gt; Match::GitHelper.commit_changes(workspace, <span class="string">"add certificate, private key and provisioning profiles"</span>, git_url)</span><br></pre></td></tr></table></figure>
<p>大功告成。现在你应该可以通过<strong>fastlane</strong>命令来安装证书和provision profiles了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane match development --<span class="built_in">readonly</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2018/06/23/fastlane-jenkins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/23/fastlane-jenkins/" itemprop="url">使用Fastlane和Jenkins构建自动打包系统 (Part 1)</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-23T22:30:11+08:00">
                2018-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/23/fastlane-jenkins/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/06/23/fastlane-jenkins/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/06/23/fastlane-jenkins/" class="leancloud_visitors" data-flag-title="使用Fastlane和Jenkins构建自动打包系统 (Part 1)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>发这篇博文的目的主要是总结一些在使用fastlane过程遇到的坑，顺便吐槽一下Fastlane官方网站：写的好飘逸，对于新手来说不看几遍不试几次，完全不知到整个体系是如何的。。。最后我希望能够帮助看到这篇文章的你:]</p>
</blockquote>
<h2 id="Fastlane"><a href="#Fastlane" class="headerlink" title="Fastlane"></a>Fastlane</h2><p><img src="https://docs.fastlane.tools/img/fastlane_text.png" alt=""></p>
<p><strong>Fastlane</strong>是一种能够将iOS和android平台beta测试或者正式发布完全自动化的工具！It’s amazing dude! 它能够做的事情有：</p>
<ul>
<li>生成应用商店需要的所有截图 (本地化的截图！可以根据需要为各种语言生成）</li>
<li>处理打包时候的签名</li>
<li>发布应用到商店</li>
</ul>
<p>我们接下来以iOS为例讲解如何使用fastlane打包iOS app</p>
<h3 id="fastlane初始化配置"><a href="#fastlane初始化配置" class="headerlink" title="fastlane初始化配置"></a>fastlane初始化配置</h3><p>详细的setup步骤这里不赘述，大家可以到<a href="https://docs.fastlane.tools/getting-started/ios/setup/" target="_blank" rel="noopener">Getting started with fastlane for iOS</a>查看。</p>
<p>根据文档，安装完fastlane后，配置工程的第一个命令是(这里不建议使用swift版本的init，一个是目前是beta版本，另外一个是当前能查到的资料都是以<a href="https://www.martinfowler.com/articles/rake.html" target="_blank" rel="noopener">ruby DSL</a>来说明的):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane init</span><br></pre></td></tr></table></figure>
<p>运行这个命令之后，会看到命令行出现交互式提问，第一个问题经常是问你想用fastlane 来干嘛？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 📸  Automate screenshots (自动化appstore 本地化截图)</span><br><span class="line">2. 👩‍✈️  Automate beta distribution to TestFlight (自动化发布beta测试app到test flight)</span><br><span class="line">3. 🚀  Automate App Store distribution (appstore 发布自动化)</span><br><span class="line">4. 🛠  Manual setup - manually setup your project to automate your tasks (手动配置自己的工程)</span><br></pre></td></tr></table></figure>
<p>如果您的app有多个target或者没有找到跟workspace名字一样的scheme，fastlane会提示输入bundle id，然后会提示输入apple id及其密码，如果apple id在多个team还会提示选择team等等，总之问题问完，你的初始配置也就完成了。</p>
<p>配置完后，会在您的工程下面生成一个名为<strong>fastlane</strong>的文件夹，这个文件夹就是所有fastlane的配置所在了。文件夹会包含两个文件:</p>
<ul>
<li>Appfile: 用来存储在使用fastlane过程中所需要的有用信息，例如apple id，bundle id等</li>
<li>Fastfile: fastlane编译以及发布的核心文件，所有需要自动编译配置的代码都放到这个文件里面</li>
</ul>
<h3 id="Fastfile"><a href="#Fastfile" class="headerlink" title="Fastfile"></a>Fastfile</h3><p>现在重点讲一下如何配置<strong>Fastfile</strong>。初始化完后，fastlane会自动为工程生成如下代码在<strong>fastfile</strong>里面(我在初始化的时候选择的是第3项–appstore发布自动化，如果选择别的选项可能会与下面的例子有稍微不同)。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">platform <span class="symbol">:ios</span> <span class="keyword">do</span></span><br><span class="line">  desc <span class="string">"Push a new release build to the App Store"</span></span><br><span class="line">  lane <span class="symbol">:release</span> <span class="keyword">do</span></span><br><span class="line">    build_app(<span class="symbol">workspace:</span> <span class="string">"Spacename.xcworkspace"</span>, <span class="symbol">scheme:</span> <span class="string">"SchemeName"</span>)</span><br><span class="line">    upload_to_app_store(<span class="symbol">skip_metadata:</span> <span class="literal">true</span>, <span class="symbol">skip_screenshots:</span> <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>platform: 告诉fastlane是哪个平台。</li>
<li>desc: 注解。一般放到每个lane之前一行用于解释这个lane的作用</li>
<li>lane: 简单来讲就是一个任务的配置，比如发布到test flight算一个任务，打内部测试Adhoc包等。lane 后面跟着的是冒号加任务名称，如上代码： :release, 这样你就可以在命令行下面输入如下命令就可以执行这个任务了：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane release</span><br></pre></td></tr></table></figure>
<ul>
<li>lane的body里面能够使用的命令都叫做action，能调用的<a href="https://docs.fastlane.tools/actions" target="_blank" rel="noopener">actions</a>官方已经帮我们列出来了，而且每个action都有详细的文档。例子中的任务一眼就能看出来是做什么：编译名为<strong>Spacename.xcworkspace</strong>，scheme为<strong>SchemeName</strong>的工程，编译完后上传到app store（跳过上传meta data和screenshots）</li>
</ul>
<blockquote>
<p>读者可以亲手试一试，讲workspace和scheme改为自己工程的名字，然后在命令行运行fastlane release，之后如果编译没有失败并且itunes connect连接和验证成功的话，您会看到ipa包已经成功的传到了itunes connect的后台了。怎么样？很厉害吧，就2行代码就搞定了编译，打包，上传到appstore这种平时繁杂的任务！</p>
</blockquote>
<p>等等，我们好像漏了什么。对，最重要的程序签名！</p>
<h3 id="Fastlane-match"><a href="#Fastlane-match" class="headerlink" title="Fastlane match"></a>Fastlane match</h3><p>什么是Fastlane match? Fastlane match不仅仅是在配置fastlane自动打包时候需要用到，而且极大地简化了在一个开发团队中共享证书和provisioning profiles的流程！</p>
<ul>
<li>项目组中每来一个新成员，是不是都要花时间为新成员配置证书，并且把他加入到相应项目的provisioning profiles里面？如果项目众多，是不是管理的一场噩梦？想要简化吗？快使用<strong>Fastlane match</strong>!</li>
<li>连接到苹果服务器很慢，下载provisioning profile很慢！想每次都下载快吗？快使用<strong>Fastlane match</strong>!</li>
<li>想在团队中方便的使用个人开发者证书，而不用拷来拷去吗？快使用<strong>Fastlane match</strong>!</li>
<li>项目组有新设备后，快使用<strong>Fastlane match</strong>! 一键搞定！</li>
</ul>
<p>说了那么多好处，咱们来看看怎么用！首先在工程所在文件夹运行如下命令（确保在运行之前先运行过fastlane init命令）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane match init</span><br></pre></td></tr></table></figure>
<p>运行完后，fastlane会问用来存储工程的证书和provisioning profiles的Git repo的URL是什么？所以，马上去Github或者Gitlab上创建一个去吧！</p>
<p><strong>注意！！！</strong></p>
<ul>
<li>所有传到指定git repo的证书和provisioning profiles将会被fastlane使用OpenSSL来加密存储的。</li>
<li>你必须对曾git repo有完全的控制权力。最好保证你所使用的git repo是私有的并且使用安全的私钥。</li>
<li>即使你的证书泄露了，在不知道你的itunes connect账号的情况下并不能对你造成伤害</li>
<li>如果你使用Git hub或者Bitbuckt，建议你使用开启两步验证的itunes connect账号来作为match连接时用的账号</li>
</ul>
<p>跟随着所有提示做完后会在fastlane文件夹下生成一个叫做<strong>Matchfile</strong>的文件，初始的文件内容与下面类似：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git_url(<span class="string">"git@xxx/certificates.git"</span>)</span><br><span class="line"></span><br><span class="line">type(<span class="string">"development"</span>) <span class="comment"># The default type, can be: appstore, adhoc, enterprise or development</span></span><br><span class="line"></span><br><span class="line">app_identifier([<span class="string">"bundle identifier 1"</span>, <span class="string">"bundle identifier 2"</span>])</span><br><span class="line"><span class="comment">#username("xxx<span class="doctag">@xxx</span>.com") # Your Apple Developer Portal username</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For all available options run `fastlane match --help`</span></span><br><span class="line"><span class="comment"># Remove the # in the beginning of the line to enable the other options</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#match(app_identifier: ["bundle identifier 1", "bundle identifier 2"], type: "adhoc")</span></span><br></pre></td></tr></table></figure>
<p>初始化完后，就到为工程生成证书和provisioning profiles了 ，（如果不是新项目，想利用已经存在的证书怎么办？这部分也有解决方案，我打算放到part 2的时候再讲）运行如下命令，就会为工程生成development证书和相应的provisiong profile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane match development</span><br></pre></td></tr></table></figure>
<p>第一次运行这个命令会提示请输入passphase，这个passphase就是用来加密证书和provisioning profiles用的。</p>
<p><strong>注意</strong>: 运行以上命令,如果发现没有相应的证书和provisiong profiles就会生成新的证书和provisioning profiles，所以请慎用！</p>
<p>接下来，如果想在一台新的机器上安装该工程的证书就可以运行下面的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane match development --readonly</span><br></pre></td></tr></table></figure>
<p>加上<strong>–readonly</strong>就能保证不会生成新的，而仅仅只是执行安装而已。除了development,我们还能指定adhoc, appstore, enterprise等参数来生成不同场景的证书。</p>
<p>生成的证书和provisioning profiles都会被加密放到初始化match时指定的git repo中，这样当使用<strong>fastlane match development</strong>或者<strong>fastlane match development –readonly</strong>的时候，fastlane会第一时间从指定的git repo中去寻找并安装，所以不需要经过苹果服务器。如果git repo是自己公司服务器的，那就更快了:]。</p>
<p>如果想一口气装上所需要的证书和provisioning profiles, 那么可以写一个脚本来完成：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">install appstore development profiles and cert</span></span><br><span class="line">fastlane match development --readonly</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">uncomment below lines <span class="keyword">if</span> you need install other types of certs</span></span><br><span class="line"><span class="meta">#</span><span class="bash">fastlane match adhoc --<span class="built_in">readonly</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">fastlane match appstore --<span class="built_in">readonly</span></span></span><br></pre></td></tr></table></figure>
<p>将脚本传到工程git上，这样只要有新机器，就运行一下这个脚本就全部装上了。</p>
<h4 id="在Fastfile中使用match"><a href="#在Fastfile中使用match" class="headerlink" title="在Fastfile中使用match"></a>在Fastfile中使用match</h4><p>配置好match后，如何在fastfile中使用呢？其实很简单，如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">platform <span class="symbol">:ios</span> <span class="keyword">do</span></span><br><span class="line">  desc <span class="string">"Push a new release build to the App Store"</span></span><br><span class="line">  lane <span class="symbol">:release</span> <span class="keyword">do</span></span><br><span class="line">  	sync_code_signing</span><br><span class="line">    build_app(<span class="symbol">workspace:</span> <span class="string">"Spacename.xcworkspace"</span>, <span class="symbol">scheme:</span> <span class="string">"SchemeName"</span>)</span><br><span class="line">    upload_to_app_store(<span class="symbol">skip_metadata:</span> <span class="literal">true</span>, <span class="symbol">skip_screenshots:</span> <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>只需要在编译之前调用sync_code_signing即可！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2017/08/24/agile-desgin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/24/agile-desgin/" itemprop="url">敏捷设计之SOLID原则</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-24T15:38:11+08:00">
                2017-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/24/agile-desgin/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/08/24/agile-desgin/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/24/agile-desgin/" class="leancloud_visitors" data-flag-title="敏捷设计之SOLID原则">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="敏捷设计之SOLID原则"><a href="#敏捷设计之SOLID原则" class="headerlink" title="敏捷设计之SOLID原则"></a>敏捷设计之SOLID原则</h2><h3 id="把握所学东西的本质"><a href="#把握所学东西的本质" class="headerlink" title="把握所学东西的本质"></a>把握所学东西的本质</h3><p>在讨论SOLID原则之前，我们需要明确一点，就是这个规则是为了解决什么问题而被发明出来的。只有弄清楚这一点，才能够在实际工作中正确应用。举个栗子吧，比如为什么要采用MVC？教科书般的回答就是MVC就是Model-View-Controller，然后将Model,View和Controller各自按照教科书说一遍。你觉得你真的理解为什么要用MVC了吗？举个简单的例子说明非MVC是什么样的吧？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">set conn=Server.CreateObject(<span class="string">"ADODB.Connection"</span>)</span><br><span class="line">conn.Provider=<span class="string">"Microsoft.Jet.OLEDB.4.0"</span></span><br><span class="line">conn.Open(Server.Mappath(<span class="string">"/db/northwind.mdb"</span>))</span><br><span class="line">set rs = Server.CreateObject(<span class="string">"ADODB.recordset"</span>)</span><br><span class="line">rs.Open <span class="string">"Select * from Customers"</span>, conn</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> until rs.EOF</span><br><span class="line">    <span class="keyword">for</span> each x <span class="keyword">in</span> rs.Fields</span><br><span class="line">       Response.Write(x.name)</span><br><span class="line">       Response.Write(<span class="string">" = "</span>)</span><br><span class="line">       Response.Write(x.value &amp; <span class="string">"&lt;br&gt;"</span>) </span><br><span class="line">    next</span><br><span class="line">    Response.Write(<span class="string">"&lt;br&gt;"</span>)</span><br><span class="line">    rs.MoveNext</span><br><span class="line">loop</span><br><span class="line"></span><br><span class="line">rs.close</span><br><span class="line">conn.close</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure>
<p>这是一段ASP classic的代码。这段代码的问题：</p>
<ul>
<li>无法在类似逻辑的页面重用使用数据库的代码。为了满足快速迭代的需求，将会促使程序员自然而然的使用copy-paste大法。</li>
<li>页面的显示与数据库代码混在一起，如果需求变化，要调整页面显示将会变得很麻烦。一个页面还好，如果是几十个这种代码的页面呢？</li>
</ul>
<p>所以，从如何能够让这段代码重用为出发点，MVC在不断的试验与测试中诞生了。MVC的优点总结请自行Google。</p>
<h3 id="设计臭味"><a href="#设计臭味" class="headerlink" title="设计臭味"></a>设计臭味</h3><p>设计一个软件的结构或者架构的时候，如果没有足够的经验，经常会产生如下问题:</p>
<h4 id="僵化性"><a href="#僵化性" class="headerlink" title="僵化性"></a>僵化性</h4><p>僵化性是指对软件进行改动，即使是简单的改动。如果单一的改动会导致有依赖关系的模块中的连锁改动，那么设计就是僵化的。</p>
<h4 id="脆弱性"><a href="#脆弱性" class="headerlink" title="脆弱性"></a>脆弱性</h4><p>脆弱性是指，在进行一个改动时，可能会导致程序的许多地方出现问题。</p>
<h4 id="顽固性"><a href="#顽固性" class="headerlink" title="顽固性"></a>顽固性</h4><p>顽固性是指，设计中包含了对其他有用的部分，但是要把这些部分从系统中分离出来所需要的努力和风险却是巨大的，这是一种令人遗憾，但非常常见的情况。</p>
<h4 id="粘滞性"><a href="#粘滞性" class="headerlink" title="粘滞性"></a>粘滞性</h4><p>粘滞性是指，当面临一个改动时，开发人员尝尝发现有多种改动的方法。其中，有一些会保持敏捷设计，而另外一些则会破坏设计。比如，如果编译所花费的时间很长，那么开发人员就会被诱导去做不会导致大规模编译的举动。</p>
<h4 id="不必要的复杂性"><a href="#不必要的复杂性" class="headerlink" title="不必要的复杂性"></a>不必要的复杂性</h4><p>如果设计中包含了当前没用的组成部分，它就含有不必要的复杂性。当开发人员预测需求的变化，并在软件中放置了处理潜在变化的代码时，尝尝出现这种情况。起初，这样做看起来貌似是一件好事，但是结果尝尝正好相反。为过多的可能性做准备，致使设计由于含有绝不会用到的结构而变得混乱。</p>
<h4 id="不必要的重复性"><a href="#不必要的重复性" class="headerlink" title="不必要的重复性"></a>不必要的重复性</h4><p>copy-paste</p>
<h4 id="晦涩性"><a href="#晦涩性" class="headerlink" title="晦涩性"></a>晦涩性</h4><p>晦涩性是指模块难以理解。</p>
<p>怎么能尽量避免产生以上问题呢？那就需要借鉴敏捷设计。</p>
<h3 id="敏捷设计原则之SOLID"><a href="#敏捷设计原则之SOLID" class="headerlink" title="敏捷设计原则之SOLID"></a>敏捷设计原则之SOLID</h3><p>大家都听说过敏捷开发宣言， 其中最后一条是”随时应对变化<strong>重于</strong>遵循计划”。要达这目的并且避免写出有臭味的代码，就需要引入敏捷设计，就是要让自己的代码够“敏捷”。我认为只有代码具有敏捷设计思想，敏捷开发宣言所倡导的才能够顺利实现。打个比喻，中国古代打战有许多排兵布阵的阵法，想想看如果使用的是一个玄妙无比的阵法，比如八卦阵，但是执行阵法的士兵大部分都是老弱残兵以及老幼妇孺，恐怕连阵势都摆不出来就战败了吧。我们这里说的敏捷设计原则就像士兵一样，是基石。</p>
<p>那到底什么是敏捷设计呢？敏捷设计是一个过程，不是一个事件。它是一个持续的应用原则、模式以及实践来改进软件的<strong>结构</strong>和<strong>可读性</strong>的过程。它致力于保持系统在任何事件都尽可能的<strong>简单干净</strong>以及富有表达力。</p>
<p>接下来，我们学习敏捷设计原则，但请记住，敏捷开发人员不会把这些原则应用到一个庞大的预先设计中。相反，这些原则被应用在一次次的迭代中，力图使代码以及代码所表达的设计保持干净。</p>
<h4 id="单一职责原则-SRP"><a href="#单一职责原则-SRP" class="headerlink" title="单一职责原则(SRP)"></a>单一职责原则(SRP)</h4><blockquote>
<p>一个类应该只有一个发生变化的原因</p>
</blockquote>
<p>如果一个类承担的职责过多，就等于把这些职责耦合在了一起。一个职责的变化可能会削弱或者抑制这个类完成其他职责的能力。</p>
<p>考虑下图的设计：<br><img src="http://ot51d7lis.bkt.clouddn.com/Rectangle%201.png" alt=""></p>
<p>这个设计违反了SRP，显然Rectangle有两个职责。导致的问题：</p>
<ul>
<li>打包到GUI程序中的时候，需要将计算机几何应用库与图形绘制应用库一起打包</li>
<li>如果依赖的任何一个库发生了改变，则需要重新对程序打包。如果忘记做，而仅仅只是更新其中一个库的话，将会导致不可预料的错误。</li>
</ul>
<p>改进：<br><img src="http://ot51d7lis.bkt.clouddn.com/Rectangle_good%20%281%29.png" alt=""></p>
<h4 id="开放关闭原则-OCP"><a href="#开放关闭原则-OCP" class="headerlink" title="开放关闭原则(OCP)"></a>开放关闭原则(OCP)</h4><blockquote>
<p>一个类对修改关闭，对扩展开放。具体来说就是，一个类在不修改它本身的代码的前提下允许扩展它的行为(如果不修改做不到到话，尽量把修改做到最小化)</p>
</blockquote>
<p>OCP 听起来并不复杂，但是却不是那么容易实践的。因为通常情况下，为一个功能而设计可以对未来需求开放的类并不简单。这里重要的点是<strong>未来需求</strong>。当我们并不知道未来软件的需求的时候，我们将怎样设计类，模块，功能等来迎合需求呢？这就是OCP不容易实践的原因，通常需要彻底的思考设计。</p>
<p>我们该如何去解决这个问题呢？当设计类结构的时候，需要用心确类的扩展简单。设计阶段，将所有类的用例记下来，并对所有用例给出合适的接口。抽象类是一种能够确保类能够被扩展的手段，但是要小心不要违反<strong>SRP</strong>，当想让一个类做更多事情的时候就很容易发生。</p>
<h5 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h5><p>该例子是一个计算个人所得税的例子。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Individual</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> salary : <span class="type">Double</span>;</span><br><span class="line">    <span class="keyword">let</span> age : <span class="type">NSInteger</span>;</span><br><span class="line">    <span class="keyword">let</span> name : <span class="type">String</span>;</span><br><span class="line">    <span class="keyword">let</span> countryCode : <span class="type">String</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(salary : <span class="type">Double</span>,</span><br><span class="line">         age : <span class="type">NSInteger</span>,</span><br><span class="line">         name : <span class="type">String</span>,</span><br><span class="line">         countryCode : <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.countryCode = countryCode;</span><br><span class="line">        <span class="keyword">self</span>.salary = salary;</span><br><span class="line">        <span class="keyword">self</span>.age = age;</span><br><span class="line">        <span class="keyword">self</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaxCalculator</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">calculate</span><span class="params">(<span class="number">_</span> individual : Individual)</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> tax : <span class="type">Double</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//Just use flat calculation algorithm for simplicity as </span></span><br><span class="line">        <span class="comment">//here we just use it to demostrate OCP.</span></span><br><span class="line">        <span class="keyword">switch</span> individual.countryCode &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"cn"</span>:</span><br><span class="line">            tax = individual.salary * <span class="number">0.18</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"us"</span>:</span><br><span class="line">            tax = individual.salary * <span class="number">0.20</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"jp"</span>:</span><br><span class="line">            tax = individual.salary * <span class="number">0.50</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            tax = <span class="number">0.1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tax;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="现有设计的缺点"><a href="#现有设计的缺点" class="headerlink" title="现有设计的缺点"></a>现有设计的缺点</h5><p>现有设计的缺点很明显，如果我们想要增加一个新的国家的个税计算，则一定需要更改现有的TaxCalculator的代码。显然，当前设计不对扩展开放。</p>
<h5 id="一个更好的符合OCP的设计"><a href="#一个更好的符合OCP的设计" class="headerlink" title="一个更好的符合OCP的设计"></a>一个更好的符合OCP的设计</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">CalculateTax</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">calculate</span><span class="params">(<span class="number">_</span> individual : Individual)</span></span> -&gt; <span class="type">Double</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChinaTaxCalculator</span>: <span class="title">NSObject</span>, <span class="title">CalculateTax</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">calculate</span><span class="params">(<span class="number">_</span> individual: Individual)</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> individual.salary * <span class="number">0.18</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">USATaxCalculator</span>: <span class="title">NSObject</span>, <span class="title">CalculateTax</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">calculate</span><span class="params">(<span class="number">_</span> individual: Individual)</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> individual.salary * <span class="number">0.20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JapanTaxCalculator</span>: <span class="title">NSObject</span>, <span class="title">CalculateTax</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">calculate</span><span class="params">(<span class="number">_</span> individual: Individual)</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> individual.salary * <span class="number">0.50</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaxCalculator</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">calculate</span><span class="params">(taxHandler : CalculateTax, individual : Individual)</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taxHandler.calculate(individual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，如果增加一个国家的税收计算，只需要添加一个相应国家的税收计算类<strong>XXTaxCalculator</strong>即可，并不需要更改任何已有代码。如果项目按照以下划分程序依赖库的结构，则只需要重新编译具体实现了各个国家税收的库就行了。</p>
<p><img src="http://ot51d7lis.bkt.clouddn.com/Better%20OCP%20design.png" alt=""></p>
<h4 id="Liskov替换原则-LSP"><a href="#Liskov替换原则-LSP" class="headerlink" title="Liskov替换原则(LSP)"></a>Liskov替换原则(LSP)</h4><blockquote>
<p>Liskov 替换原则说的是如果D是B的派生类，则任何B的应用都必须能够被D的实例替换而不会影响到程序运行的逻辑或者功能。换句话说，就是派生类必须能够完全替换基类。</p>
</blockquote>
<p>我们先看一个大概只要你学Liskov原则都会看到的一个违反Liskov原则的例子。</p>
<h5 id="违反Liskov替换原则的例子"><a href="#违反Liskov替换原则的例子" class="headerlink" title="违反Liskov替换原则的例子"></a>违反Liskov替换原则的例子</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> width : <span class="type">Double</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> height : <span class="type">Double</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(width : <span class="type">Double</span>, height : <span class="type">Double</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.width = width;</span><br><span class="line">        <span class="keyword">self</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">area</span><span class="params">()</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.width * height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> : <span class="title">Rectangle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> _width : <span class="type">Double</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> _height : <span class="type">Double</span> = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">public</span> <span class="keyword">var</span> width: <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> _width;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(newWidth) &#123;</span><br><span class="line">            _width = newWidth;</span><br><span class="line">            _height = newWidth;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">public</span> <span class="keyword">var</span> height: <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> _height;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> (newHeight) &#123;</span><br><span class="line">            _width = newHeight;</span><br><span class="line">            _height = newHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createRectangle</span><span class="params">(width : Double, height : Double)</span></span> -&gt; <span class="type">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Square</span>(width: width, height: height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Someday we use createRectangle method somewhere in our application.</span></span><br><span class="line"><span class="keyword">var</span> rect:<span class="type">Rectangle</span> = createRectangle(width : <span class="number">3</span>, height : <span class="number">3</span>);</span><br><span class="line">rect.area();<span class="comment">//result is 9 as expected</span></span><br><span class="line"></span><br><span class="line">rect.height = <span class="number">10</span>;</span><br><span class="line">rect.width = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">rect.area();<span class="comment">//opps!result is 25 not 50!</span></span><br></pre></td></tr></table></figure>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p>这个原则是对OCP的一个扩展，他告诉我们从基类派生出新的派生类的时候，我们必须保证不要破坏原有的行为。</p>
<h4 id="接口隔离原则-ISP"><a href="#接口隔离原则-ISP" class="headerlink" title="接口隔离原则(ISP)"></a>接口隔离原则(ISP)</h4><blockquote>
<p>接口隔离原则讲的是接口实现者不能被强迫实现或者依赖一些不会用到的方法</p>
</blockquote>
<p>举个例子，当我们将一个模块从应用程序中抽象出多个子模块的时候需要小心注意了。假设这个模块是基于类实现的，那我们能够从类抽象出接口（注：这些接口都会在现有系统被逐一实现）。但当我们把模块加入到一个与原系统相比仅含有某些接口的实现，有可能会发生这种结果：为了保证模块能够正常运行，不得不在新系统中被迫实现所有的接口并且有相当一部分接口不会被用到，这部分不会被用到的接口通常为空实现或者返回虚假值，就为了实现接口而实现。通常发生这种情况的接口叫做胖接口或者被污染的接口。</p>
<h5 id="一个违反了ISP的实际例子"><a href="#一个违反了ISP的实际例子" class="headerlink" title="一个违反了ISP的实际例子"></a>一个违反了ISP的实际例子</h5><p>在早期的ASP.NET 2.0版本中，如果网站想实现自己的membership provider，则需要将需要或者不需要的所有接口都实现一遍。如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMembershipProvider</span> : <span class="title">MembershipProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> ApplicationName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">ChangePassword</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">string</span> oldPassword, <span class="keyword">string</span> newPassword</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">ChangePasswordQuestionAndAnswer</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">string</span> password, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">string</span> newPasswordQuestion, <span class="keyword">string</span> newPasswordAnswer</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MembershipUser <span class="title">CreateUser</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">string</span> password, <span class="keyword">string</span> email, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">string</span> passwordQuestion, <span class="keyword">string</span> passwordAnswer, <span class="keyword">bool</span> isApproved, <span class="keyword">object</span> providerUserKey, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">out</span> MembershipCreateStatus status</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">DeleteUser</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">bool</span> deleteAllRelatedData</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> EnablePasswordReset</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> EnablePasswordRetrieval</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MembershipUserCollection <span class="title">FindUsersByEmail</span>(<span class="params"><span class="keyword">string</span> emailToMatch, <span class="keyword">int</span> pageIndex, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pageSize, <span class="keyword">out</span> <span class="keyword">int</span> totalRecords</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MembershipUserCollection <span class="title">FindUsersByName</span>(<span class="params"><span class="keyword">string</span> usernameToMatch, <span class="keyword">int</span> pageIndex, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pageSize, <span class="keyword">out</span> <span class="keyword">int</span> totalRecords</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MembershipUserCollection <span class="title">GetAllUsers</span>(<span class="params"><span class="keyword">int</span> pageIndex, <span class="keyword">int</span> pageSize, <span class="keyword">out</span> <span class="keyword">int</span> totalRecords</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">GetNumberOfUsersOnline</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">GetPassword</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">string</span> answer</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MembershipUser <span class="title">GetUser</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">bool</span> userIsOnline</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MembershipUser <span class="title">GetUser</span>(<span class="params"><span class="keyword">object</span> providerUserKey, <span class="keyword">bool</span> userIsOnline</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">GetUserNameByEmail</span>(<span class="params"><span class="keyword">string</span> email</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> MaxInvalidPasswordAttempts</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> MinRequiredNonAlphanumericCharacters</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> MinRequiredPasswordLength</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> PasswordAttemptWindow</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> MembershipPasswordFormat PasswordFormat</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> PasswordStrengthRegularExpression</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> RequiresQuestionAndAnswer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> RequiresUniqueEmail</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">ResetPassword</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">string</span> answer</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">UnlockUser</span>(<span class="params"><span class="keyword">string</span> userName</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateUser</span>(<span class="params">MembershipUser user</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">ValidateUser</span>(<span class="params"><span class="keyword">string</span> username, <span class="keyword">string</span> password</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"The method or operation is not implemented."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Holy crap! 这是一大堆东西！可能有的时候，你仅仅是想将现有的membership provider的一部分改变成自己的而已，但是你要面对的是全部实现，这就麻烦了。如果你不懂ASP.NET没关系，这里这个例子只是想展示一种违反了ISP后的结果。</p>
<h5 id="一个更简单通俗的例子来说明ISP"><a href="#一个更简单通俗的例子来说明ISP" class="headerlink" title="一个更简单通俗的例子来说明ISP"></a>一个更简单通俗的例子来说明ISP</h5><p>首先看代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> : <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"feed with bone"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snake</span> : <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"feed with mice"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随后，你注意到有些动物是宠物，有宠物的一些特性或者与人互动的方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//梳理毛发</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">groom</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> : <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"feed with bone"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">groom</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"grooming and dog feel comfortable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snake</span> : <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"feed with mice"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">groom</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//ignore this method as I am not going to groom a feaking snake.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写到这里，你就发现问题了。Animal接口被污染了。在Snake类上它要求我们实现一个并不需要的方法。好的做法是把宠物相关的方法抽象出来。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="comment">//梳理毛发</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">groom</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> : <span class="title">Animal</span>, <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"feed with bone"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">groom</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"grooming and dog feel comfortable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snake</span> : <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">feed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"feed with mice"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="依赖反转-DIP"><a href="#依赖反转-DIP" class="headerlink" title="依赖反转(DIP)"></a>依赖反转(DIP)</h4><blockquote>
<p>A. High-level 模块不应该依赖 low-level 模块。两者都应该依赖于抽象<br>B. 抽象不能依赖于具体实现。具体实现应该依赖于抽象</p>
</blockquote>
<h5 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h5><p>一个简单的例子，我们经常使用DAO(Database access object)来封装数据库操作的逻辑。下面这个例子，将数据库具体的类OracleConnection直接在DAO类里面了。那如果我们想把数据库换成Mysql，怎么办呢？（想想一下，有很多DAO类，里面的逻辑都很复杂很多）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleConnection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">open</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//open database connection logic</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DAO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> databaseConnection : <span class="type">OracleConnection</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        databaseConnection = <span class="type">OracleConnection</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">commitChanges</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">        databaseConnection.<span class="keyword">open</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//deal with data base changes</span></span><br><span class="line">        </span><br><span class="line">        databaseConnection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>符合DIP的写法:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">DatabaseConnection</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">open</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleConnection</span> : <span class="title">DatabaseConnection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">open</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//open database connection logic</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlConnection</span> : <span class="title">DatabaseConnection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">open</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//open database connection logic</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DAO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> databaseConnection : <span class="type">DatabaseConnection</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(databaseConnection : <span class="type">DatabaseConnection</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.databaseConnection = databaseConnection;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">commitChanges</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">        databaseConnection.<span class="keyword">open</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//deal with data base changes</span></span><br><span class="line">        </span><br><span class="line">        databaseConnection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>咋一看，细节上可能跟Liskov要求的很像，但是请注意，DIP主要强调的是模块之间的依赖。下面用一个例子来感受一下</p>
<p><img src="http://ot51d7lis.bkt.clouddn.com/DIP%20%281%29.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2017/07/28/algorithm-dijstra/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/28/algorithm-dijstra/" itemprop="url">最短路径之迪杰斯特拉算法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-28T23:36:29+08:00">
                2017-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/28/algorithm-dijstra/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/07/28/algorithm-dijstra/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/28/algorithm-dijstra/" class="leancloud_visitors" data-flag-title="最短路径之迪杰斯特拉算法">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cin</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//maximum number of nodes</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxnum = <span class="number">100</span>;</span><br><span class="line"><span class="comment">//maxWeight represents infinite large</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxWeight = <span class="number">99999</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///Calculate the shortest path based on dijstra algorithm.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///@param v source node index</span></span><br><span class="line"><span class="comment">///@param n number of nodes</span></span><br><span class="line"><span class="comment">///@param dist to save the distance between the ith node and the source node </span></span><br><span class="line"><span class="comment">///@param record the ith node's previous node.</span></span><br><span class="line"><span class="comment">///@param arcs line matrix</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dijstra</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> n, <span class="keyword">int</span> *dist, <span class="keyword">int</span> *prev, <span class="keyword">int</span> arcs[maxnum][maxnum])</span> </span>&#123;</span><br><span class="line">    <span class="comment">//bool array marks which node has been put to S.</span></span><br><span class="line">    <span class="comment">//S is an array that contains nodes which makes up of the shortest path.</span></span><br><span class="line">    <span class="keyword">bool</span> included[n];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        included[i] = <span class="literal">false</span>;</span><br><span class="line">        dist[i] = arcs[v][i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//if the distance is not maxWeight, then it means there </span></span><br><span class="line">        <span class="comment">//is a line between the v and the ith node. so set the ith</span></span><br><span class="line">        <span class="comment">//node's previous to v.</span></span><br><span class="line">        <span class="keyword">if</span>(dist[i] &lt; maxWeight) &#123;</span><br><span class="line">            prev[i] = v;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev[i] = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//start from the source node v, so put it to S by default.</span></span><br><span class="line">    included[v] = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//self to self is 0.</span></span><br><span class="line">    dist[v] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> min = maxWeight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> w;</span><br><span class="line">        <span class="comment">//find min distance between the source node and the ith</span></span><br><span class="line">        <span class="comment">//node. the ith node must not be in S.</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!included[j] &amp;&amp; dist[j] &lt; min) &#123;</span><br><span class="line">                min = dist[j];</span><br><span class="line">                w = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//put the w node into the S.</span></span><br><span class="line">        included[w] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!included[j] &amp;&amp; min + arcs[w][j] &lt; dist[j]) &#123;</span><br><span class="line">                dist[j] = min + arcs[w][j];</span><br><span class="line">                prev[j] = w;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::ifstream ifin;</span><br><span class="line">    <span class="comment">//number of nodes</span></span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="comment">//number of lines</span></span><br><span class="line">    <span class="keyword">int</span> lines;</span><br><span class="line">    <span class="keyword">int</span> arcs[maxnum][maxnum];</span><br><span class="line"></span><br><span class="line">    ifin.open(<span class="string">"sample.txt"</span>);</span><br><span class="line">    <span class="keyword">if</span>(ifin.is_open()) &#123;</span><br><span class="line">        ifin &gt;&gt; n;</span><br><span class="line">        ifin &gt;&gt; lines;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lines; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> row, column, weight;</span><br><span class="line">            ifin &gt;&gt; row &gt;&gt; column &gt;&gt; weight;</span><br><span class="line"></span><br><span class="line">            arcs[row][column] = weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"could not open sample.txt "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ifin.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; n &lt;&lt; <span class="string">" nodes "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; lines &lt;&lt; <span class="string">" lines "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//to save the distance between the ith node and the source node </span></span><br><span class="line">    <span class="keyword">int</span> dist[n];</span><br><span class="line">    <span class="comment">//to record the ith node's previous node.</span></span><br><span class="line">    <span class="keyword">int</span> prev[n];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//init arcs</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(arcs[i][j] == <span class="number">0</span>) &#123;</span><br><span class="line">                arcs[i][j] = maxWeight;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; arcs[i][j] &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> v = <span class="number">0</span>;</span><br><span class="line">    dijstra(v, n, dist, prev, arcs);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"distance between "</span>&lt;&lt; v &lt;&lt;<span class="string">" and last point is :"</span> &lt;&lt; dist[n<span class="number">-1</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"shortest path is ["</span>;</span><br><span class="line">    <span class="keyword">int</span> k = n - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; path(<span class="number">1</span>,k);</span><br><span class="line">    <span class="keyword">while</span>(prev[k] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        k = prev[k];</span><br><span class="line">        path.push_back(k);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::reverse_iterator iter = path.rbegin(); iter != path.rend(); ++iter) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; *iter &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"]"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2017/07/23/find-non-include-regex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/23/find-non-include-regex/" itemprop="url">找出不包含某个字符串的正则表达式</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-23T22:42:43+08:00">
                2017-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/正则表达式/" itemprop="url" rel="index">
                    <span itemprop="name">正则表达式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/23/find-non-include-regex/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/07/23/find-non-include-regex/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/23/find-non-include-regex/" class="leancloud_visitors" data-flag-title="找出不包含某个字符串的正则表达式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="找出不包含某个字符串的正则表达式"><a href="#找出不包含某个字符串的正则表达式" class="headerlink" title="找出不包含某个字符串的正则表达式"></a>找出不包含某个字符串的正则表达式</h2><p>经常我们会遇到想找出不包含某个字符串，例如”hello”的文本，最容易想到的是在正则表达式里使用[^hello]，但这样的正则表达式完全是另外一个意思，它的意思是字符串里不能包含’h’，’e’，’l’, ‘o’四个单字符。那什么样的正则表达式能过滤出不包含完整“hello”字串的信息呢？事实上，说正则表达式里不支持逆向匹配并不是百分之百的正确。</p>
<p>我们就可以使用<strong>否定式查找</strong>来模拟出逆向匹配，从而解决我们的问题, 表达式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^((?!hello).)*$</span><br></pre></td></tr></table></figure>
<p>上面这个表达式就能过滤出不包含<strong>‘hello’</strong>字串的信息。</p>
<p>先解释一下<strong>?!</strong>的用法：</p>
<blockquote>
<p>零宽负向先行断言(?!exp)，只会匹配后缀exp不存在的位置。例如，\d{3}(?!\d)匹配三位数字，而且这三位数字的后面不能是数字</p>
</blockquote>
<p>现在解释表达式<strong>((?!hello).)*</strong>：</p>
<p>表达式<strong>(?!hello)</strong>.会往前查找，看看前面是不是没有“hello”字串，如果没有(是其它字符)，那么.(点号)就会匹配这些其它字符。<strong>这种正则表达式的“查找”也叫做“zero-width-assertions”(零宽度断言)</strong>，因为它不会捕获任何的字符，只是判断。</p>
<p>我们来看一下<strong>“Nonnullhelloworld”</strong>这个字符串。</p>
<blockquote>
<p><strong>(?!hello)</strong>会检查每个字符串后面跟的是不是<strong>‘hello’</strong>，如果不是，.就匹配这个字符。表达式<strong>(?!hello)</strong>只执行一次，所以将这个表达式用括弧包裹组成组，然后用星号*修饰来匹配零次或多次。</p>
</blockquote>
<p>匹配<strong>Nonnullhelloworld</strong>返回false, 说明该字符串含有<strong>‘hello’</strong>子串。<br>匹配<strong>Nonnullworld</strong>返回true<br>匹配<strong>Nonnullworldhello</strong>返回false<br>匹配<strong>hello</strong>返回false</p>
<p>所以，你可以认为当表达式返回false的时候，说明该字符串包含指定子串。</p>
<p>最后推荐一个好的，快速的测试正则表达式的在线网站，我用起来很不错(居然还有正则表达式的解释，真是有点强大哈，还不快自己尝试一下)：<br><a href="https://regex101.com/" target="_blank" rel="noopener">https://regex101.com/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2017/07/18/react-life-cycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/18/react-life-cycle/" itemprop="url">React Component lifecycle</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-18T12:17:55+08:00">
                2017-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/react/" itemprop="url" rel="index">
                    <span itemprop="name">react</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/18/react-life-cycle/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/07/18/react-life-cycle/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/18/react-life-cycle/" class="leancloud_visitors" data-flag-title="React Component lifecycle">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="React-Component-lifecycle"><a href="#React-Component-lifecycle" class="headerlink" title="React Component lifecycle"></a>React Component lifecycle</h2><p>最近刚开始使用react-native做项目，有一些心得，所以在这里发表一下。对没有接触过的技术和开发环境，了解核心component的生命周期是非常重要的。能够保证在写代码的过程中不容易犯错。</p>
<h3 id="什么是component？"><a href="#什么是component？" class="headerlink" title="什么是component？"></a>什么是component？</h3><p>根据React官方文档，<strong>React.component</strong>是一个抽象基类。能够让使用者将UI拆成各个独立地，可重用的component。常见的使用场景是继承它并提供一个<strong>render()</strong>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;h1&gt;Hello, &#123;this.props.name&#125;&lt;/h1&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="React-lifecycle-methods"><a href="#React-lifecycle-methods" class="headerlink" title="React lifecycle methods"></a>React lifecycle methods</h2><p><img src="http://ot51d7lis.bkt.clouddn.com/React%20component%20life%20cycle2.png" alt=""></p>
<p>上面这张图展示了一个React component的声明周期，从创建到销毁。接下来将逐步介绍以上各个方法并阐述什么时候使用使用它们。</p>
<blockquote>
<p>Mount单词，字典上的意思是：”to get up on something above the level of the ground; especially:to seat oneself (as on a horse) for riding” 后面这段意思很形象，骑上马，可以跑了 :[</p>
</blockquote>
<h3 id="componentWillMount"><a href="#componentWillMount" class="headerlink" title="componentWillMount"></a>componentWillMount</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentWillMount()</span><br></pre></td></tr></table></figure>
<p>当这个方法被调用的时候，说明你的component将要出现在屏幕上。渲染方法<strong>render</strong>将要被调用。在这个方法内你能干什么呢？</p>
<p>答案是，你可能不能干太多的事情。因为当<strong>componentWillMount</strong>被调用的时候，还没有任何component能够使用，所以你也无法对DOM做任何事情。</p>
<p>另外，大部分初始化已经被component的<strong>constructor</strong>完成了(构造函数是你初始化默认值的最佳地方)</p>
<p>说到这里，你可能觉得这个方法真没用。但是，这里有一个例外场景，就是当你要在<strong>运行时</strong>为整个app<strong>初始化全局配置</strong>的时候, 并且要保证第一时间初始化方法被调用，这个方法是有特别有用的。这就意味着你的component中几乎99%以上都不会用到这个方法。</p>
<p>你可能会看到有人在这个方法里面启动AJAX calls或者执行一个Promise函数。不要这样做，下面会详细讲述原因。</p>
<blockquote>
<p><em>常用场景</em>：需要在运行时确定的App相关的配置<br><em>是否能够使用setState</em>: 否</p>
</blockquote>
<h3 id="componentDidMount"><a href="#componentDidMount" class="headerlink" title="componentDidMount"></a>componentDidMount</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount()</span><br></pre></td></tr></table></figure>
<p>这个方法运行时，你的component已经加载上并已可使用。在这个方法里面你可以做很多事情，例如：</p>
<ul>
<li>在一个已经渲染好的画板上绘制新的元素</li>
<li>添加event listeners</li>
<li>加载数据。为什么这个方法里面适合加载数据呢？因为你无法保证一个异步的请求在component加载完成之前完成，它是不确定的。在某些情况下，还可能会在component unmount之后请求的response才返回回来，而这个时候如果根据response来设置state的话就会产生异常。使用componentDidMount至少可以保证在结果返回之前是有component可以使用的（但是，如果response返回时不进行处理的话，也有可能会发生错误。本文提供一种ES6 promise的解决方案，请看<a href="#cancelablePromise">make cancelable promise</a>）</li>
</ul>
<p>基本上，你可以做任何事情</p>
<blockquote>
<p><em>常用场景</em>：发起Ajax请求来加载数据<br><em>是否能够使用setState</em>: 是</p>
</blockquote>
<h3 id="componentWillReceiveProps"><a href="#componentWillReceiveProps" class="headerlink" title="componentWillReceiveProps"></a>componentWillReceiveProps</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentWillReceiveProps(nextProps)</span><br></pre></td></tr></table></figure>
<p>这个方法被用来接收新的props。也许一些数据在parent component中加载并被传到当前compoent中。</p>
<p>当component能够对新的props做出任何动作之前，componentWillReceiveProps会被调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">	<span class="keyword">if</span>(nextProps.text !=== <span class="keyword">this</span>.props.text) &#123;</span><br><span class="line">		<span class="keyword">this</span>.setState(&#123;<span class="attr">text</span>: nextProps.text&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过代码可以看到，在该方法中，我们可以同时访问当前props和nextProps。所以我们要做的就是：</p>
<ul>
<li>检查props是否有变化</li>
<li>如果有变化，就做出相应的变化</li>
</ul>
<p><strong>注意</strong></p>
<ul>
<li>React也许会在props没有变化的时候调用该方法。所以总是判断props是否变化是有必要的。这种情况可能发生在parent component引起当前组件re-render。</li>
<li>React不会在component初始化，设置初始props的调用该方法</li>
<li>调用<strong>this.setState</strong>通常不会触发该方法</li>
</ul>
<blockquote>
<p><em>常用场景</em>：针对props的变化做出相应的状态改变<br><em>是否能够使用setState</em>: 是</p>
</blockquote>
<h3 id="shouldComponentUpdate"><a href="#shouldComponentUpdate" class="headerlink" title="shouldComponentUpdate"></a>shouldComponentUpdate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shouldComponentUpdate(nextProps, nextState)</span><br></pre></td></tr></table></figure>
<p>使用这个方法告诉React当前state或者props的变化是否会引起re-render。默认情况下，这个方法总是返回true，即需要re-render。如果你想要避免一些无意义或者纯属浪费的re-render，这个方法是你最好的选择。</p>
<p>P.S 根据react最新官方文档，目前，如果<strong>shouldComponentUpdate</strong>方法返回false,则componentWillUpdate(), render() 和 componentDidUpdate()方法都不会被调用。但是，在未来的react版本中，<strong> shouldComponentUpdate</strong>的返回值只具有参考价值而不是强制性的，所以方法返回false后component也有可能会re-render。</p>
<blockquote>
<p><em>常用场景</em>：控制component是否需要re-render<br><em>是否能够使用setState</em>: NO</p>
</blockquote>
<h3 id="componentWillUpdate"><a href="#componentWillUpdate" class="headerlink" title="componentWillUpdate"></a>componentWillUpdate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentWillUpdate(nextProps, nextState)</span><br></pre></td></tr></table></figure>
<p>这个方法在re-render之前会被调用。这个方法跟<strong> componentWillReceiveProps</strong>类似，只是你不能在该方法里调用this.setState。</p>
<p>如果你的component使用了<strong>shouldComponentUpdate</strong>并且当props变化的时候需要做一些事情，那么<strong>componentWillUpdate</strong>是一个不错的选择。</p>
<blockquote>
<p><em>常用场景</em>：在有shouldComponentUpdate方法的component中配合着用<br><em>是否能够使用setState</em>: NO</p>
</blockquote>
<h3 id="componentDidUpdate"><a href="#componentDidUpdate" class="headerlink" title="componentDidUpdate"></a>componentDidUpdate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentDidUpdate(prevProps, prevState)</span><br></pre></td></tr></table></figure>
<p>在component 更新之后，使用这个方法来操作DOM。这个方法也是一个发送网络请求的好的选择之一，前提是需要判断当前props和prevProps相比是否产生了变化（如果props没有变化，则不需要发送网络请求）</p>
<blockquote>
<p><em>常用场景</em>：根据props或者state的变化，对DOM进行相应的变化<br><em>是否能够使用setState</em>: YES</p>
</blockquote>
<h3 id="componentDidUpdate-1"><a href="#componentDidUpdate-1" class="headerlink" title="componentDidUpdate"></a>componentDidUpdate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentWillUnmount()</span><br></pre></td></tr></table></figure>
<p>这个方法会在component从屏幕上移除和销毁之前调用。在这个方法中，你需要进行任何必要的清理工作，比如取消network request，invalidate timers，remove event listeners或者清除任何在<strong>componentDidMount()</strong>中创建的DOM元素。</p>
<blockquote>
<p><em>常用场景</em>：清理一切需要必须清理的资源，事务或者事件<br><em>是否能够使用setState</em>: NO</p>
</blockquote>
<h2 id="make-cancelable-promise"><a href="#make-cancelable-promise" class="headerlink" title="make cancelable promise"></a><a id="cancelablePromise">make cancelable promise</a></h2><p>使用Promise发起异步请求，等到异步请求返回的时候，component有可能已经unmounted了。这个时候在response的callback尝试setState会引发异常。怎么避免这种情况呢？</p>
<p>感谢@istarkov提供了一种可取消的Promise的方案：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> makeCancelable = <span class="function">(<span class="params">promise</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> hasCanceled_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> wrappedPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    promise.then(</span><br><span class="line">      val =&gt; hasCanceled_ ? reject(&#123;<span class="attr">isCanceled</span>: <span class="literal">true</span>&#125;) : resolve(val),</span><br><span class="line">      error =&gt; hasCanceled_ ? reject(&#123;<span class="attr">isCanceled</span>: <span class="literal">true</span>&#125;) : reject(error)</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    promise: wrappedPromise,</span><br><span class="line">    cancel() &#123;</span><br><span class="line">      hasCanceled_ = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如何使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cancelablePromise = makeCancelable(</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> component.setState(&#123;...&#125;&#125;))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">cancelablePromise</span><br><span class="line">  .promise</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'resolved'</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'isCanceled'</span>, reason.isCanceled));</span><br><span class="line"></span><br><span class="line">cancelablePromise.cancel(); <span class="comment">// Cancel the promise</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gobodigo.com/2017/07/16/ios-iap-product-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Charles Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.svg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SIGABRT">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/16/ios-iap-product-types/" itemprop="url">iOS 内购商品类型</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-16T22:49:27+08:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/16/ios-iap-product-types/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/07/16/ios-iap-product-types/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/16/ios-iap-product-types/" class="leancloud_visitors" data-flag-title="iOS 内购商品类型">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="iOS-内购商品类型"><a href="#iOS-内购商品类型" class="headerlink" title="iOS 内购商品类型"></a>iOS 内购商品类型</h2><p>由于最近的项目有IAP，所以又重温了一遍iOS IAP的知识。在开发的过程中，发现网络上的各种文档都有，当然最详细的还是苹果官方IAP文档，但是苹果对每种类型介绍太官方(官话)，让刚开始看的人不太容易弄懂每种商品的区别。另外，深刻理解每种商品对后面的开发非常有帮助。所以，我觉得有必要说一下。</p>
<p>IAP的类型一共4种，接下来，我将对每一种进行通俗易懂的解释。</p>
<h3 id="Consumable-products-消费类型内购"><a href="#Consumable-products-消费类型内购" class="headerlink" title="Consumable products (消费类型内购)"></a>Consumable products (消费类型内购)</h3><p>苹果官方解释</p>
<blockquote>
<p>Items that get used up over the course of running your app. Examples include minutes for a Voice over IP app and one-time services such as voice transcription.</p>
</blockquote>
<p>这种产品类型应该大家都知道，很好懂。但是如果仅根据苹果的两个例子，这两个例子都是跟语音通话相关，一个没使用过任何内购的人还真不好理解。通俗来讲，就好比你去菜市场里边，你花X元买了Y个苹果，然后这个交易就完成了。</p>
<p>该类型的内购的例子很多，比如你玩游戏的时候，花了X元买了N个钻石；花X元兑换了N个虚拟币用于购买app中的某些虚拟服务等。</p>
<p>顾名思义，这种类型的商品的特点就是商品可消耗，可重复购买。每次购买的值一般都会叠加。如果买了后，用户不消耗，则一直存在用户相关的账号中。</p>
<h3 id="Non-consumable-products-非消费类型内购"><a href="#Non-consumable-products-非消费类型内购" class="headerlink" title="Non-consumable products (非消费类型内购)"></a>Non-consumable products (非消费类型内购)</h3><p>该种类型的商品主要用于解锁app上的一些功能，或者游戏的某个关卡，又或者是获得某项主题之类的。总之就是当用户购买后，这个商品就一直生效，不需要重复购买。</p>
<h3 id="Auto-renewable-subscriptions-自动续费类型的内购"><a href="#Auto-renewable-subscriptions-自动续费类型的内购" class="headerlink" title="Auto-renewable subscriptions (自动续费类型的内购)"></a>Auto-renewable subscriptions (自动续费类型的内购)</h3><p>这种类型的商品有点跟Non-consumable商品类似，目的都是用户付钱后提供app中特定的某些功能。最大的不同是，该类商品有是有期限的。比如，某些app的VIP系统，这种系统一般按月计算，需要用户按照价格每月扣费。只有用户续费后，VIP才生效并且VIP相关的特权才能够生效。过期不续费，则VIP失效。</p>
<p>该类商品与Non-consumable products的区别是</p>
<ul>
<li>有过期时间</li>
<li>可重复购买(系统自动续订)</li>
<li>该类商品的内容一般都会不断的更新</li>
</ul>
<p>与Consumable products的区别是</p>
<ul>
<li>这种商品买了就等于开始消耗，不用用户主动进行后续操作</li>
<li>有过期时间</li>
<li>苹果系统自动帮用户续费购买</li>
</ul>
<h3 id="Non-renewable-subscriptions"><a href="#Non-renewable-subscriptions" class="headerlink" title="Non-renewable subscriptions"></a>Non-renewable subscriptions</h3><p>这种类型的商品跟Auto-renewable subscriptions的商品非常像，目的也是为了给用户提供持续服务的类型。最大的区别是，与该商品相关的续订的信息都由你的服务器保存和处理。简而言之，就是如果你选了Auto-renewable subscriptions，则苹果帮你搞定一切，包括用户的自动续订。但如果你选了Non-renewable subscriptions做为你提供的商品的类型，则你需要负责续订以及过期时间的管理，以及让用户购买的商品在用户所有的设备上可用（只要用户正确登录你的服务器）。哦，对了，还有恢复购买也需要你负责。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/logo.svg"
                alt="Charles Liu" />
            
              <p class="site-author-name" itemprop="name">Charles Liu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/windseason" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:liuchao853@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/CNonnull" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/charles.liu.853" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Charles Liu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'zgEelpnfa3Opcz1YXjhB7Ajs-gzGzoHsz',
        appKey: 'rwpME5PEjRwUrkjOwzBFmCys',
        placeholder: '说点什么呗',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("zgEelpnfa3Opcz1YXjhB7Ajs-gzGzoHsz", "rwpME5PEjRwUrkjOwzBFmCys");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook,Evernote,Linkedin,Reddit";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>
